name: Build Xray-core with BoringSSL

on:
  workflow_call:
    inputs:
      xray_version:
        description: "Xray-core version to build"
        required: false
        type: string
        default: "v25.10.15"
  workflow_dispatch:
    inputs:
      xray_version:
        description: "Xray-core version to build"
        required: false
        default: "v25.10.15"
      build_abis:
        description: "Comma-separated ABIs to build"
        required: false
        default: "arm64-v8a,armeabi-v7a,x86_64"

jobs:
  build-boringssl:
    name: Build BoringSSL
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        # Temporarily disable armeabi-v7a due to build issues
        # Will re-enable after fixing BoringSSL build for ARMv7
        abi: [arm64-v8a, x86_64]
        include:
          - abi: arm64-v8a
            toolchain: aarch64-linux-android24
            cmake_arch: arm64-v8a
          - abi: x86_64
            toolchain: x86_64-linux-android24
            cmake_arch: x86_64

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Initialize Valid Submodules
        run: |
          # Only initialize the valid submodule (hev-socks5-tunnel)
          git submodule sync || true
          git submodule update --init app/src/main/jni/hev-socks5-tunnel || true

      - name: Setup NDK
        run: |
          wget -qO android-ndk.zip https://dl.google.com/android/repository/android-ndk-r28c-linux.zip
          unzip -q android-ndk.zip
          rm android-ndk.zip
          NDK_HOME=$(realpath android-ndk-*)
          echo "NDK_HOME=$NDK_HOME" >> $GITHUB_ENV
          echo "NDK_HOME=$NDK_HOME" >> $GITHUB_PATH

      - name: Install Build Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build cmake

      - name: Clone BoringSSL
        run: |
          BORINGSSL_DIR="app/src/main/jni/perf-net/third_party/boringssl"

          # Create directory structure if it doesn't exist
          mkdir -p "$(dirname "$BORINGSSL_DIR")"

          # Check if BoringSSL is already cloned and valid
          if [ -d "$BORINGSSL_DIR" ] && [ -f "$BORINGSSL_DIR/CMakeLists.txt" ]; then
            echo "‚úÖ BoringSSL directory already exists and is valid"
          else
            echo "üì¶ Cloning BoringSSL..."
            
            # Remove any existing directory or submodule reference
            if [ -d "$BORINGSSL_DIR" ]; then
              echo "üßπ Removing existing BoringSSL directory..."
              rm -rf "$BORINGSSL_DIR"
            fi
            
            # Remove any .git submodule reference file that might exist
            if [ -f "$(dirname "$BORINGSSL_DIR")/.git" ]; then
              echo "üßπ Removing submodule reference..."
              rm -f "$(dirname "$BORINGSSL_DIR")/.git"
            fi
            
            # Try cloning from googlesource first
            if git clone --depth=1 https://boringssl.googlesource.com/boringssl "$BORINGSSL_DIR" 2>&1; then
              echo "‚úÖ BoringSSL cloned successfully from googlesource"
            else
              echo "‚ö†Ô∏è  Failed to clone from googlesource, trying GitHub mirror..."
              # Clean up partial clone if any
              rm -rf "$BORINGSSL_DIR"
              # Fallback to GitHub mirror
              git clone --depth=1 https://github.com/google/boringssl.git "$BORINGSSL_DIR" || {
                echo "‚ùå Failed to clone BoringSSL from both sources"
                exit 1
              }
              echo "‚úÖ BoringSSL cloned successfully from GitHub"
            fi
            
            # Verify clone was successful
            if [ ! -f "$BORINGSSL_DIR/CMakeLists.txt" ]; then
              echo "‚ùå BoringSSL CMakeLists.txt not found after clone!"
              exit 1
            fi
          fi

      - name: Build BoringSSL
        run: |
          BORINGSSL_DIR="app/src/main/jni/perf-net/third_party/boringssl"

          # Verify BoringSSL has CMakeLists.txt
          if [ ! -f "$BORINGSSL_DIR/CMakeLists.txt" ]; then
            echo "‚ùå BoringSSL CMakeLists.txt not found!"
            exit 1
          fi

          echo "‚úÖ Building BoringSSL from $BORINGSSL_DIR"
          cd "$BORINGSSL_DIR"
          TOOLCHAIN_DIR="$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64"
          BUILD_DIR="build_${{ matrix.abi }}"
          mkdir -p "$BUILD_DIR"
          cd "$BUILD_DIR"

          echo "üîß Configuring CMake for ${{ matrix.abi }}..."

          # Base CMake arguments
          CMAKE_ARGS=(
            ".."
            "-DCMAKE_SYSTEM_NAME=Android"
            "-DCMAKE_SYSTEM_VERSION=24"
            "-DANDROID_ABI=${{ matrix.cmake_arch }}"
            "-DCMAKE_ANDROID_ARCH_ABI=${{ matrix.cmake_arch }}"
            "-DCMAKE_ANDROID_NDK=$NDK_HOME"
            "-DCMAKE_TOOLCHAIN_FILE=$NDK_HOME/build/cmake/android.toolchain.cmake"
            "-DCMAKE_BUILD_TYPE=Release"
            "-DOPENSSL_SMALL=1"
            "-DOPENSSL_NO_DEPRECATED=1"
            "-DOPENSSL_NO_ASM=0"
            "-DBUILD_SHARED_LIBS=OFF"
            "-GNinja"
          )

          # Add ABI-specific compiler flags
          # Note: NDK toolchain automatically sets correct architecture based on ANDROID_ABI
          # Custom -march flags are not needed and can cause conflicts with Clang
          # The problematic -march=armv8-a+simd+crypto flag comes from somewhere else and conflicts
          if [ "${{ matrix.abi }}" = "arm64-v8a" ]; then
            echo "üì± Configuring for ARM64 (crypto extensions enabled by default in NDK)"
            # NDK r28c with arm64-v8a automatically enables crypto extensions
            # No need for explicit -march flags as they conflict with Clang's target detection
            # Ensure we're using the correct ABI to avoid toolchain confusion
            CMAKE_ARGS+=(
              "-DANDROID_PLATFORM=android-24"
            )
          fi

          echo "Running CMake configuration with ${#CMAKE_ARGS[@]} arguments..."
          cmake "${CMAKE_ARGS[@]}" || {
            echo "‚ùå CMake configuration failed for ${{ matrix.abi }}"
            echo "CMake version:"
            cmake --version
            echo "NDK_HOME: $NDK_HOME"
            exit 1
          }

          echo "üî® Building BoringSSL with Ninja..."
          echo "Ninja version:"
          ninja --version || echo "Ninja not found"

          # Build crypto and ssl libraries specifically
          echo "Building crypto and ssl targets..."
          BUILD_SUCCESS=false

          # Try building specific targets first
          if ninja crypto ssl 2>&1; then
            echo "‚úÖ Crypto and SSL targets built successfully"
            BUILD_SUCCESS=true
          else
            echo "‚ö†Ô∏è  Specific targets failed, trying full build..."
            if ninja -j$(nproc) 2>&1; then
              echo "‚úÖ Full build completed"
              BUILD_SUCCESS=true
            else
              BUILD_EXIT_CODE=$?
              echo "‚ùå Ninja build failed for ${{ matrix.abi }} with exit code: $BUILD_EXIT_CODE"
              echo "Build directory contents:"
              ls -la . || true
              echo ""
              echo "Checking what was actually built:"
              find . -name "*.a" -type f 2>/dev/null | head -10 || echo "No .a files found"
              exit $BUILD_EXIT_CODE
            fi
          fi

          # Verify build actually produced something
          if [ "$BUILD_SUCCESS" = "true" ]; then
            A_FILES=$(find . -name "*.a" -type f 2>/dev/null | wc -l)
            if [ "$A_FILES" -eq "0" ]; then
              echo "‚ö†Ô∏è  Build reported success but no .a files found!"
              echo "Build directory structure:"
              find . -type f | head -20
              exit 1
            fi
          fi

          echo "‚úÖ BoringSSL build complete for ${{ matrix.abi }}"

          # Immediately check for libraries in standard locations
          echo "üîç Checking for built libraries..."
          if [ -f "crypto/libcrypto.a" ] && [ -f "ssl/libssl.a" ]; then
            echo "‚úÖ Libraries found in standard location"
            ls -lh crypto/libcrypto.a ssl/libssl.a
          else
            echo "‚ö†Ô∏è  Libraries not in standard location, searching..."
            CRYPTO_LIB=$(find . -name "libcrypto.a" -type f 2>/dev/null | head -1)
            SSL_LIB=$(find . -name "libssl.a" -type f 2>/dev/null | head -1)
            
            if [ -n "$CRYPTO_LIB" ] && [ -n "$SSL_LIB" ]; then
              echo "‚úÖ Libraries found in alternative locations:"
              echo "  crypto: $CRYPTO_LIB"
              echo "  ssl: $SSL_LIB"
              # Copy to expected location (use absolute paths)
              mkdir -p crypto ssl
              CRYPTO_ABS=$(cd "$(dirname "$CRYPTO_LIB")" && pwd)/$(basename "$CRYPTO_LIB")
              SSL_ABS=$(cd "$(dirname "$SSL_LIB")" && pwd)/$(basename "$SSL_LIB")
              cp "$CRYPTO_ABS" crypto/libcrypto.a
              cp "$SSL_ABS" ssl/libssl.a
              echo "‚úÖ Libraries copied to standard locations"
              ls -lh crypto/libcrypto.a ssl/libssl.a
            else
              echo "‚ùå Libraries not found anywhere!"
              echo "All .a files in build directory:"
              find . -name "*.a" -type f 2>/dev/null || echo "No .a files found"
              exit 1
            fi
          fi

          # Debug: List all build artifacts (we're still in BUILD_DIR)
          echo "üìã Current directory: $(pwd)"
          echo "üìã Build directory structure:"
          ls -la . || echo "Cannot list current directory"
          echo ""
          echo "üìã Searching for all .a files in build directory:"
          find . -name "*.a" -type f || echo "No .a files found"
          echo ""
          echo "üìã Checking crypto directory:"
          if [ -d "crypto" ]; then
            echo "‚úÖ crypto directory exists"
            ls -lah crypto/ | head -10
            find crypto -name "*.a" -type f || echo "No .a files in crypto/"
          else
            echo "‚ùå crypto directory does not exist in $(pwd)!"
            echo "Listing parent directory:"
            ls -la .. || true
          fi
          echo ""
          echo "üìã Checking ssl directory:"
          if [ -d "ssl" ]; then
            echo "‚úÖ ssl directory exists"
            ls -lah ssl/ | head -10
            find ssl -name "*.a" -type f || echo "No .a files in ssl/"
          else
            echo "‚ùå ssl directory does not exist in $(pwd)!"
            echo "Listing parent directory:"
            ls -la .. || true
          fi

          # Verify files exist before leaving build directory
          echo "üîç Final verification of built libraries..."
          CRYPTO_LIB="crypto/libcrypto.a"
          SSL_LIB="ssl/libssl.a"

          if [ -f "$CRYPTO_LIB" ] && [ -f "$SSL_LIB" ]; then
            echo "‚úÖ Both libraries found in build directory!"
            ls -lh "$CRYPTO_LIB" "$SSL_LIB"
            echo "‚úÖ Libraries verified successfully"
          else
            echo "‚ùå Libraries not found in build directory!"
            echo "Current directory: $(pwd)"
            echo "Looking for: $CRYPTO_LIB and $SSL_LIB"
            echo ""
            echo "Build directory contents:"
            ls -la . || echo "Cannot list directory"
            echo ""
            echo "All .a files in build directory:"
            find . -type f -name "*.a" 2>/dev/null | head -20 || echo "No .a files found"
            echo ""
            echo "Checking crypto directory:"
            if [ -d "crypto" ]; then
              ls -la crypto/ || echo "Cannot list crypto directory"
            else
              echo "crypto directory does not exist!"
            fi
            echo ""
            echo "Checking ssl directory:"
            if [ -d "ssl" ]; then
              ls -la ssl/ || echo "Cannot list ssl directory"
            else
              echo "ssl directory does not exist!"
            fi
            echo ""
            echo "‚ö†Ô∏è  Build may have completed but libraries are in unexpected location"
            echo "Checking parent directory:"
            find .. -maxdepth 2 -name "*.a" -type f 2>/dev/null | head -10 || echo "No .a files in parent"
            exit 1
          fi

      - name: Verify BoringSSL Artifacts
        run: |
          BORINGSSL_DIR="app/src/main/jni/perf-net/third_party/boringssl"
          BUILD_DIR="$BORINGSSL_DIR/build_${{ matrix.abi }}"
          CRYPTO_LIB="$BUILD_DIR/crypto/libcrypto.a"
          SSL_LIB="$BUILD_DIR/ssl/libssl.a"

          echo "üîç Verifying BoringSSL artifacts for ${{ matrix.abi }}..."
          echo "Current directory: $(pwd)"
          echo "Expected paths (absolute):"
          echo "  - $CRYPTO_LIB"
          echo "  - $SSL_LIB"

          # Check if directories exist
          if [ ! -d "$BUILD_DIR" ]; then
            echo "‚ùå Build directory does not exist: $BUILD_DIR"
            echo "Listing parent directory:"
            ls -la "$(dirname "$BUILD_DIR")" || echo "Parent directory does not exist"
            exit 1
          fi

          # Check build directory contents
          echo "üìã Build directory contents:"
          ls -la "$BUILD_DIR" || echo "Cannot list build directory"

          # Search for all .a files in build directory
          echo "üìã Searching for .a files in build directory:"
          find "$BUILD_DIR" -name "*.a" -type f || echo "No .a files found"

          # Check crypto library
          if [ ! -f "$CRYPTO_LIB" ]; then
            echo "‚ùå libcrypto.a not found at $CRYPTO_LIB"
            echo "Listing $BUILD_DIR/crypto:"
            if [ -d "$BUILD_DIR/crypto" ]; then
              ls -lah "$BUILD_DIR/crypto/" || echo "Cannot list crypto directory"
              find "$BUILD_DIR/crypto" -name "*.a" -type f || echo "No .a files in crypto/"
            else
              echo "‚ùå crypto directory does not exist at $BUILD_DIR/crypto"
            fi
            exit 1
          fi

          # Check ssl library
          if [ ! -f "$SSL_LIB" ]; then
            echo "‚ùå libssl.a not found at $SSL_LIB"
            echo "Listing $BUILD_DIR/ssl:"
            if [ -d "$BUILD_DIR/ssl" ]; then
              ls -lah "$BUILD_DIR/ssl/" || echo "Cannot list ssl directory"
              find "$BUILD_DIR/ssl" -name "*.a" -type f || echo "No .a files in ssl/"
            else
              echo "‚ùå ssl directory does not exist at $BUILD_DIR/ssl"
            fi
            exit 1
          fi

          echo "‚úÖ Both artifacts found:"
          ls -lh "$CRYPTO_LIB" "$SSL_LIB"

      - name: Upload BoringSSL Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: boringssl-${{ matrix.abi }}
          path: |
            app/src/main/jni/perf-net/third_party/boringssl/build_${{ matrix.abi }}/crypto/libcrypto.a
            app/src/main/jni/perf-net/third_party/boringssl/build_${{ matrix.abi }}/ssl/libssl.a
          retention-days: 7
          if-no-files-found: error

  build-xray:
    name: Build Xray-core with BoringSSL
    runs-on: ubuntu-22.04
    needs: build-boringssl
    strategy:
      matrix:
        # Temporarily disable armeabi-v7a due to build issues
        abi: [arm64-v8a, x86_64]
        include:
          - abi: arm64-v8a
            goarch: arm64
            toolchain: aarch64-linux-android24
          - abi: x86_64
            goarch: amd64
            toolchain: x86_64-linux-android24

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Initialize Valid Submodules
        run: |
          # Only initialize the valid submodule (hev-socks5-tunnel)
          git submodule sync || true
          git submodule update --init app/src/main/jni/hev-socks5-tunnel || true

      - name: Read Versions
        run: |
          # Check if input version is provided (from workflow_call)
          INPUT_VERSION="${{ inputs.xray_version }}"

          if [ -f "version.properties" ]; then
            XRAY_VERSION=$(grep 'XRAY_CORE_VERSION' version.properties | cut -d '=' -f 2)
            GO_VERSION=$(grep 'GO_VERSION' version.properties | cut -d '=' -f 2)
            # Use input version if provided, otherwise use version.properties
            if [ -n "$INPUT_VERSION" ] && [ "$INPUT_VERSION" != "v25.10.15" ]; then
              XRAY_VERSION="$INPUT_VERSION"
            fi
            echo "XRAY_VERSION=$XRAY_VERSION" >> $GITHUB_ENV
            echo "GO_VERSION=$GO_VERSION" >> $GITHUB_ENV
          else
            # Use input version or default
            XRAY_VERSION="${INPUT_VERSION:-v25.10.15}"
            echo "XRAY_VERSION=$XRAY_VERSION" >> $GITHUB_ENV
            echo "GO_VERSION=1.25.3" >> $GITHUB_ENV
          fi

          echo "Building Xray-core version: $XRAY_VERSION"
          echo "Using Go version: $GO_VERSION"

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: Setup NDK
        run: |
          wget -qO android-ndk.zip https://dl.google.com/android/repository/android-ndk-r28c-linux.zip
          unzip -q android-ndk.zip
          rm android-ndk.zip
          NDK_HOME=$(realpath android-ndk-*)
          echo "NDK_HOME=$NDK_HOME" >> $GITHUB_ENV

      - name: Download BoringSSL Artifacts
        uses: actions/download-artifact@v4
        with:
          name: boringssl-${{ matrix.abi }}
          path: boringssl-${{ matrix.abi }}

      - name: Verify BoringSSL Artifacts Downloaded
        run: |
          ARTIFACT_DIR="boringssl-${{ matrix.abi }}"
          CRYPTO_LIB="$ARTIFACT_DIR/crypto/libcrypto.a"
          SSL_LIB="$ARTIFACT_DIR/ssl/libssl.a"

          echo "üîç Verifying downloaded BoringSSL artifacts..."

          if [ ! -f "$CRYPTO_LIB" ]; then
            echo "‚ùå libcrypto.a not found in downloaded artifacts"
            echo "Listing $ARTIFACT_DIR:"
            find "$ARTIFACT_DIR" -type f || echo "Directory does not exist"
            exit 1
          fi

          if [ ! -f "$SSL_LIB" ]; then
            echo "‚ùå libssl.a not found in downloaded artifacts"
            echo "Listing $ARTIFACT_DIR:"
            find "$ARTIFACT_DIR" -type f || echo "Directory does not exist"
            exit 1
          fi

          echo "‚úÖ Both artifacts downloaded successfully:"
          ls -lh "$CRYPTO_LIB" "$SSL_LIB"

      - name: Clone Xray-core
        run: |
          git clone --depth=1 https://github.com/XTLS/Xray-core.git
          cd Xray-core
          if [ -n "$XRAY_VERSION" ] && [ "$XRAY_VERSION" != "latest" ]; then
            git checkout "$XRAY_VERSION" || echo "‚ö†Ô∏è  Version $XRAY_VERSION not found, using latest"
          fi
          COMMIT=$(git rev-parse HEAD | cut -c 1-7)
          echo "XRAY_COMMIT=$COMMIT" >> $GITHUB_ENV
          echo "XRAY_COMMIT=$COMMIT" >> $GITHUB_OUTPUT

      - name: Apply Patches (Optional)
        run: |
          cd Xray-core
          echo "‚ÑπÔ∏è  Patches are optional - BoringSSL is linked via CGO flags"
          echo "‚ÑπÔ∏è  If patches fail, build continues with vanilla Xray-core + BoringSSL linking"
          
          if [ -d "../xray-patches" ]; then
            PATCH_COUNT=0
            SUCCESS_COUNT=0
            SKIP_COUNT=0
            
            for patch in ../xray-patches/*.patch; do
              if [ -f "$patch" ]; then
                PATCH_COUNT=$((PATCH_COUNT + 1))
                PATCH_NAME=$(basename "$patch")
                
                # Check if patch is a placeholder/comment-only file
                if ! grep -q "^diff --git\|^---\|^\+\+\+" "$patch" 2>/dev/null; then
                  echo "‚ÑπÔ∏è  Skipping $PATCH_NAME (placeholder/documentation only)"
                  SKIP_COUNT=$((SKIP_COUNT + 1))
                  continue
                fi
                
                echo "üìù Attempting to apply patch: $PATCH_NAME"
                
                # Try to apply patch with more verbose error output
                if git apply --check "$patch" 2>&1; then
                  if git apply "$patch" 2>&1; then
                    echo "‚úÖ Successfully applied: $PATCH_NAME"
                    SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                  else
                    echo "‚ö†Ô∏è  Failed to apply: $PATCH_NAME (may already be applied)"
                  fi
                else
                  echo "‚ö†Ô∏è  Patch check failed for: $PATCH_NAME (patch may not match current codebase)"
                  echo "   This is OK - BoringSSL linking happens via CGO flags"
                  # Show what files the patch expects (if any)
                  if grep -q "^diff --git\|^---\|^\+\+\+" "$patch" 2>/dev/null; then
                    echo "   Patch expects to modify:"
                    grep -E "^diff --git|^---|^\+\+\+" "$patch" | head -5 || true
                  fi
                fi
              fi
            done
            
            if [ $PATCH_COUNT -eq 0 ]; then
              echo "‚ÑπÔ∏è  No patches found in xray-patches directory"
            else
              echo "üìä Patch summary: $SUCCESS_COUNT applied, $SKIP_COUNT skipped, $((PATCH_COUNT - SUCCESS_COUNT - SKIP_COUNT)) failed"
              if [ $SUCCESS_COUNT -eq 0 ]; then
                echo "‚ÑπÔ∏è  No patches were applied - this is OK"
                echo "‚ÑπÔ∏è  BoringSSL will be linked via CGO flags in the build step"
              fi
            fi
          else
            echo "‚ÑπÔ∏è  No patches directory found - this is OK"
            echo "‚ÑπÔ∏è  BoringSSL will be linked via CGO flags in the build step"
          fi
          
          echo "‚úÖ Patch step complete - proceeding to build with BoringSSL linking"

      - name: Build Xray-core with BoringSSL
        run: |
          cd Xray-core

          # Set up Go environment
          export GOOS=android
          export GOARCH=${{ matrix.goarch }}

          TOOLCHAIN_DIR="$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64"
          export AR=$TOOLCHAIN_DIR/bin/llvm-ar
          export RANLIB=$TOOLCHAIN_DIR/bin/llvm-ranlib
          export STRIP=$TOOLCHAIN_DIR/bin/llvm-strip

          # Set BoringSSL library paths
          BORINGSSL_CRYPTO="$(realpath ../boringssl-${{ matrix.abi }}/crypto/libcrypto.a)"
          BORINGSSL_SSL="$(realpath ../boringssl-${{ matrix.abi }}/ssl/libssl.a)"
          BORINGSSL_INCLUDE="$(realpath ../app/src/main/jni/perf-net/third_party/boringssl/include)"

          if [ ! -f "$BORINGSSL_CRYPTO" ] || [ ! -f "$BORINGSSL_SSL" ]; then
            echo "‚ùå BoringSSL libraries not found!"
            exit 1
          fi

          # Build Xray-core with BoringSSL
          # Note: Android cross-compilation requires CGO_ENABLED=1 (Go limitation)
          echo "Building Xray-core with BoringSSL for ${{ matrix.abi }}..."
          export GOOS=android
          export CGO_ENABLED=1
          export GOARCH=${{ matrix.goarch }}
          
          TOOLCHAIN_DIR="$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64"
          export CC=$TOOLCHAIN_DIR/bin/${{ matrix.toolchain }}-clang
          export CXX=$TOOLCHAIN_DIR/bin/${{ matrix.toolchain }}-clang++
          
          # Set CGO flags to link BoringSSL
          # Both crypto and ssl directories need to be in library path
          BORINGSSL_CRYPTO_DIR=$(dirname "$BORINGSSL_CRYPTO")
          BORINGSSL_SSL_DIR=$(dirname "$BORINGSSL_SSL")
          
          # Set sysroot for Android NDK
          NDK_SYSROOT="$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/sysroot"
          ANDROID_API=24
          
          # Map ABI to NDK library path architecture
          case "${{ matrix.abi }}" in
            arm64-v8a)
              NDK_ARCH="aarch64-linux-android"
              ;;
            armeabi-v7a)
              NDK_ARCH="arm-linux-androideabi"
              ;;
            x86_64)
              NDK_ARCH="x86_64-linux-android"
              ;;
            x86)
              NDK_ARCH="i686-linux-android"
              ;;
            *)
              echo "‚ùå Unknown ABI: ${{ matrix.abi }}"
              exit 1
              ;;
          esac
          
          # Android system library path (NDK r28c requires explicit path)
          ANDROID_LIB_DIR="$NDK_SYSROOT/usr/lib/$NDK_ARCH/$ANDROID_API"
          
          # Verify library directory exists
          if [ ! -d "$ANDROID_LIB_DIR" ]; then
            echo "‚ö†Ô∏è  Android lib directory not found: $ANDROID_LIB_DIR"
            echo "   Trying alternative locations..."
            # Try alternative locations
            ALT_DIRS=(
              "$NDK_SYSROOT/usr/lib/$NDK_ARCH"
              "$NDK_SYSROOT/usr/lib64"
              "$NDK_SYSROOT/usr/lib"
            )
            for ALT_DIR in "${ALT_DIRS[@]}"; do
              if [ -d "$ALT_DIR" ]; then
                ANDROID_LIB_DIR="$ALT_DIR"
                echo "‚úÖ Using alternative: $ANDROID_LIB_DIR"
                break
              fi
            done
          fi
          
          # Set LIBRARY_PATH environment variable (most reliable method)
          export LIBRARY_PATH="$ANDROID_LIB_DIR:$LIBRARY_PATH"
          
          export CGO_CFLAGS="-I$BORINGSSL_INCLUDE --sysroot=$NDK_SYSROOT"
          
          # Android system libraries: liblog and libandroid
          # NDK r28c requires explicit library search path (-L flag)
          # -L: Library search path (where to find liblog.so, libandroid.so)
          # -llog: Android logging library (required by Xray-core's Android logging calls)
          # -landroid: Android native library (may be needed by some Go modules)
          # --sysroot: Tell linker where to find system libraries
          export CGO_LDFLAGS="-L$BORINGSSL_CRYPTO_DIR -L$BORINGSSL_SSL_DIR -L$ANDROID_LIB_DIR -lcrypto -lssl -static -llog -landroid --sysroot=$NDK_SYSROOT -Wl,--as-needed"
          
          echo "üìã Android system libraries configuration:"
          echo "   NDK Sysroot: $NDK_SYSROOT"
          echo "   Android API: $ANDROID_API"
          echo "   NDK Arch: $NDK_ARCH"
          echo "   Library Dir: $ANDROID_LIB_DIR"
          echo "   LIBRARY_PATH: $LIBRARY_PATH"
          echo "   Linking: -llog -landroid"
          
          # Verify libraries exist
          if [ -f "$ANDROID_LIB_DIR/liblog.so" ] || [ -f "$ANDROID_LIB_DIR/liblog.a" ]; then
            echo "‚úÖ liblog found in $ANDROID_LIB_DIR"
          else
            echo "‚ö†Ô∏è  liblog not found in $ANDROID_LIB_DIR (may still work with LIBRARY_PATH)"
            ls -la "$ANDROID_LIB_DIR" | grep -E "log|android" || echo "   Directory listing failed"
          fi
          
          echo "üîó BoringSSL linking configuration:"
          echo "   CGO_CFLAGS: $CGO_CFLAGS"
          echo "   CGO_LDFLAGS: $CGO_LDFLAGS"
          echo "   BoringSSL Crypto: $BORINGSSL_CRYPTO"
          echo "   BoringSSL SSL: $BORINGSSL_SSL"
          echo "   Crypto Dir: $BORINGSSL_CRYPTO_DIR"
          echo "   SSL Dir: $BORINGSSL_SSL_DIR"
          
          # Verify library directories exist
          if [ ! -d "$BORINGSSL_CRYPTO_DIR" ]; then
            echo "‚ùå Crypto directory not found: $BORINGSSL_CRYPTO_DIR"
            exit 1
          fi
          if [ ! -d "$BORINGSSL_SSL_DIR" ]; then
            echo "‚ùå SSL directory not found: $BORINGSSL_SSL_DIR"
            exit 1
          fi
          
          # List files in library directories for debugging
          echo "üìÅ Files in crypto directory:"
          ls -lh "$BORINGSSL_CRYPTO_DIR" || echo "Cannot list crypto directory"
          echo "üìÅ Files in ssl directory:"
          ls -lh "$BORINGSSL_SSL_DIR" || echo "Cannot list ssl directory"
          
          go build \
            -o libxray.so \
            -trimpath \
            -buildvcs=false \
            -ldflags="-X github.com/xtls/xray-core/core.build=${XRAY_COMMIT} -s -w -buildid=" \
            -v \
            ./main

          # Strip binary
          $STRIP --strip-all libxray.so

          # Verify BoringSSL linkage
          if strings libxray.so | grep -qi "BoringSSL\|boringssl"; then
            echo "‚úÖ BoringSSL symbols found in binary"
          else
            echo "‚ö†Ô∏è  Warning: BoringSSL symbols not found in binary"
          fi

          # Move to output directory
          mkdir -p ../xray-output/${{ matrix.abi }}
          mv libxray.so ../xray-output/${{ matrix.abi }}/libxray.so

      - name: Upload Xray Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: xray-${{ matrix.abi }}
          path: xray-output/${{ matrix.abi }}/libxray.so
          retention-days: 7

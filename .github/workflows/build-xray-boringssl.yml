name: Build Xray-core with BoringSSL

on:
  workflow_call:
    inputs:
      xray_version:
        description: 'Xray-core version to build'
        required: false
        type: string
        default: 'v25.10.15'
  workflow_dispatch:
    inputs:
      xray_version:
        description: 'Xray-core version to build'
        required: false
        default: 'v25.10.15'
      build_abis:
        description: 'Comma-separated ABIs to build'
        required: false
        default: 'arm64-v8a,armeabi-v7a,x86_64'

jobs:
  build-boringssl:
    name: Build BoringSSL
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        # Temporarily disable armeabi-v7a due to build issues
        # Will re-enable after fixing BoringSSL build for ARMv7
        abi: [arm64-v8a, x86_64]
        include:
          - abi: arm64-v8a
            toolchain: aarch64-linux-android24
            cmake_arch: arm64-v8a
          - abi: x86_64
            toolchain: x86_64-linux-android24
            cmake_arch: x86_64

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Initialize Valid Submodules
        run: |
          # Only initialize the valid submodule (hev-socks5-tunnel)
          git submodule sync || true
          git submodule update --init app/src/main/jni/hev-socks5-tunnel || true

      - name: Setup NDK
        run: |
          wget -qO android-ndk.zip https://dl.google.com/android/repository/android-ndk-r28c-linux.zip
          unzip -q android-ndk.zip
          rm android-ndk.zip
          NDK_HOME=$(realpath android-ndk-*)
          echo "NDK_HOME=$NDK_HOME" >> $GITHUB_ENV
          echo "NDK_HOME=$NDK_HOME" >> $GITHUB_PATH

      - name: Install Build Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build cmake

      - name: Clone BoringSSL
        run: |
          BORINGSSL_DIR="app/src/main/jni/perf-net/third_party/boringssl"
          
          # Create directory structure if it doesn't exist
          mkdir -p "$(dirname "$BORINGSSL_DIR")"
          
          # Check if BoringSSL is already cloned and valid
          if [ -d "$BORINGSSL_DIR" ] && [ -f "$BORINGSSL_DIR/CMakeLists.txt" ]; then
            echo "‚úÖ BoringSSL directory already exists and is valid"
          else
            echo "üì¶ Cloning BoringSSL..."
            
            # Remove any existing directory or submodule reference
            if [ -d "$BORINGSSL_DIR" ]; then
              echo "üßπ Removing existing BoringSSL directory..."
              rm -rf "$BORINGSSL_DIR"
            fi
            
            # Remove any .git submodule reference file that might exist
            if [ -f "$(dirname "$BORINGSSL_DIR")/.git" ]; then
              echo "üßπ Removing submodule reference..."
              rm -f "$(dirname "$BORINGSSL_DIR")/.git"
            fi
            
            # Try cloning from googlesource first
            if git clone --depth=1 https://boringssl.googlesource.com/boringssl "$BORINGSSL_DIR" 2>&1; then
              echo "‚úÖ BoringSSL cloned successfully from googlesource"
            else
              echo "‚ö†Ô∏è  Failed to clone from googlesource, trying GitHub mirror..."
              # Clean up partial clone if any
              rm -rf "$BORINGSSL_DIR"
              # Fallback to GitHub mirror
              git clone --depth=1 https://github.com/google/boringssl.git "$BORINGSSL_DIR" || {
                echo "‚ùå Failed to clone BoringSSL from both sources"
                exit 1
              }
              echo "‚úÖ BoringSSL cloned successfully from GitHub"
            fi
            
            # Verify clone was successful
            if [ ! -f "$BORINGSSL_DIR/CMakeLists.txt" ]; then
              echo "‚ùå BoringSSL CMakeLists.txt not found after clone!"
              exit 1
            fi
          fi

      - name: Build BoringSSL
        run: |
          BORINGSSL_DIR="app/src/main/jni/perf-net/third_party/boringssl"
          
          # Verify BoringSSL has CMakeLists.txt
          if [ ! -f "$BORINGSSL_DIR/CMakeLists.txt" ]; then
            echo "‚ùå BoringSSL CMakeLists.txt not found!"
            exit 1
          fi
          
          echo "‚úÖ Building BoringSSL from $BORINGSSL_DIR"
          cd "$BORINGSSL_DIR"
          TOOLCHAIN_DIR="$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64"
          BUILD_DIR="build_${{ matrix.abi }}"
          mkdir -p "$BUILD_DIR"
          cd "$BUILD_DIR"

          echo "üîß Configuring CMake for ${{ matrix.abi }}..."
          
          # Base CMake arguments
          CMAKE_ARGS=(
            ".."
            "-DCMAKE_SYSTEM_NAME=Android"
            "-DCMAKE_SYSTEM_VERSION=24"
            "-DCMAKE_ANDROID_ARCH_ABI=${{ matrix.cmake_arch }}"
            "-DCMAKE_ANDROID_NDK=$NDK_HOME"
            "-DCMAKE_TOOLCHAIN_FILE=$NDK_HOME/build/cmake/android.toolchain.cmake"
            "-DCMAKE_BUILD_TYPE=Release"
            "-DOPENSSL_SMALL=1"
            "-DOPENSSL_NO_DEPRECATED=1"
            "-DOPENSSL_NO_ASM=0"
            "-DBUILD_SHARED_LIBS=OFF"
            "-GNinja"
          )
          
          # Add ABI-specific compiler flags
          if [ "${{ matrix.abi }}" = "arm64-v8a" ]; then
            echo "üì± Configuring for ARM64 with crypto extensions"
            CMAKE_ARGS+=("-DCMAKE_C_FLAGS=-march=armv8-a+simd+crypto")
            CMAKE_ARGS+=("-DCMAKE_CXX_FLAGS=-march=armv8-a+simd+crypto")
          fi
          
          echo "Running CMake configuration with ${#CMAKE_ARGS[@]} arguments..."
          cmake "${CMAKE_ARGS[@]}" || {
            echo "‚ùå CMake configuration failed for ${{ matrix.abi }}"
            echo "CMake version:"
            cmake --version
            echo "NDK_HOME: $NDK_HOME"
            exit 1
          }

          echo "üî® Building BoringSSL with Ninja..."
          echo "Ninja version:"
          ninja --version || echo "Ninja not found"
          echo "Build targets:"
          ninja -t targets all 2>/dev/null | head -20 || echo "Cannot list targets"
          echo ""
          echo "Starting build..."
          if ninja -j$(nproc) -v 2>&1 | tee /tmp/ninja-build.log; then
            echo "‚úÖ Ninja build completed"
          else
            BUILD_EXIT_CODE=$?
            echo "‚ùå Ninja build failed for ${{ matrix.abi }} with exit code: $BUILD_EXIT_CODE"
            echo "Last 50 lines of build output:"
            tail -50 /tmp/ninja-build.log || echo "Build log not available"
            echo ""
            echo "Build directory contents:"
            ls -la . || true
            echo ""
            echo "CMake cache:"
            cat CMakeCache.txt 2>/dev/null | grep -E "(CMAKE_|ANDROID_|TOOLCHAIN)" | head -20 || echo "CMakeCache.txt not found"
            exit $BUILD_EXIT_CODE
          fi

          echo "‚úÖ BoringSSL build complete for ${{ matrix.abi }}"
          
          # Debug: List all build artifacts (we're still in BUILD_DIR)
          echo "üìã Current directory: $(pwd)"
          echo "üìã Build directory structure:"
          ls -la . || echo "Cannot list current directory"
          echo ""
          echo "üìã Searching for all .a files in build directory:"
          find . -name "*.a" -type f || echo "No .a files found"
          echo ""
          echo "üìã Checking crypto directory:"
          if [ -d "crypto" ]; then
            echo "‚úÖ crypto directory exists"
            ls -lah crypto/ | head -10
            find crypto -name "*.a" -type f || echo "No .a files in crypto/"
          else
            echo "‚ùå crypto directory does not exist in $(pwd)!"
            echo "Listing parent directory:"
            ls -la .. || true
          fi
          echo ""
          echo "üìã Checking ssl directory:"
          if [ -d "ssl" ]; then
            echo "‚úÖ ssl directory exists"
            ls -lah ssl/ | head -10
            find ssl -name "*.a" -type f || echo "No .a files in ssl/"
          else
            echo "‚ùå ssl directory does not exist in $(pwd)!"
            echo "Listing parent directory:"
            ls -la .. || true
          fi
          
          # Verify files exist before leaving build directory
          if [ -f "crypto/libcrypto.a" ] && [ -f "ssl/libssl.a" ]; then
            echo "‚úÖ Both libraries found in build directory!"
            ls -lh crypto/libcrypto.a ssl/libssl.a
          else
            echo "‚ùå Libraries not found in build directory!"
            echo "Current directory: $(pwd)"
            echo "Looking for: crypto/libcrypto.a and ssl/libssl.a"
            exit 1
          fi

      - name: Verify BoringSSL Artifacts
        run: |
          BORINGSSL_DIR="app/src/main/jni/perf-net/third_party/boringssl"
          BUILD_DIR="$BORINGSSL_DIR/build_${{ matrix.abi }}"
          CRYPTO_LIB="$BUILD_DIR/crypto/libcrypto.a"
          SSL_LIB="$BUILD_DIR/ssl/libssl.a"
          
          echo "üîç Verifying BoringSSL artifacts for ${{ matrix.abi }}..."
          echo "Current directory: $(pwd)"
          echo "Expected paths (absolute):"
          echo "  - $CRYPTO_LIB"
          echo "  - $SSL_LIB"
          
          # Check if directories exist
          if [ ! -d "$BUILD_DIR" ]; then
            echo "‚ùå Build directory does not exist: $BUILD_DIR"
            echo "Listing parent directory:"
            ls -la "$(dirname "$BUILD_DIR")" || echo "Parent directory does not exist"
            exit 1
          fi
          
          # Check build directory contents
          echo "üìã Build directory contents:"
          ls -la "$BUILD_DIR" || echo "Cannot list build directory"
          
          # Search for all .a files in build directory
          echo "üìã Searching for .a files in build directory:"
          find "$BUILD_DIR" -name "*.a" -type f || echo "No .a files found"
          
          # Check crypto library
          if [ ! -f "$CRYPTO_LIB" ]; then
            echo "‚ùå libcrypto.a not found at $CRYPTO_LIB"
            echo "Listing $BUILD_DIR/crypto:"
            if [ -d "$BUILD_DIR/crypto" ]; then
              ls -lah "$BUILD_DIR/crypto/" || echo "Cannot list crypto directory"
              find "$BUILD_DIR/crypto" -name "*.a" -type f || echo "No .a files in crypto/"
            else
              echo "‚ùå crypto directory does not exist at $BUILD_DIR/crypto"
            fi
            exit 1
          fi
          
          # Check ssl library
          if [ ! -f "$SSL_LIB" ]; then
            echo "‚ùå libssl.a not found at $SSL_LIB"
            echo "Listing $BUILD_DIR/ssl:"
            if [ -d "$BUILD_DIR/ssl" ]; then
              ls -lah "$BUILD_DIR/ssl/" || echo "Cannot list ssl directory"
              find "$BUILD_DIR/ssl" -name "*.a" -type f || echo "No .a files in ssl/"
            else
              echo "‚ùå ssl directory does not exist at $BUILD_DIR/ssl"
            fi
            exit 1
          fi
          
          echo "‚úÖ Both artifacts found:"
          ls -lh "$CRYPTO_LIB" "$SSL_LIB"

      - name: Upload BoringSSL Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: boringssl-${{ matrix.abi }}
          path: |
            app/src/main/jni/perf-net/third_party/boringssl/build_${{ matrix.abi }}/crypto/libcrypto.a
            app/src/main/jni/perf-net/third_party/boringssl/build_${{ matrix.abi }}/ssl/libssl.a
          retention-days: 7
          if-no-files-found: error

  build-xray:
    name: Build Xray-core with BoringSSL
    runs-on: ubuntu-22.04
    needs: build-boringssl
    strategy:
      matrix:
        # Temporarily disable armeabi-v7a due to build issues
        abi: [arm64-v8a, x86_64]
        include:
          - abi: arm64-v8a
            goarch: arm64
            toolchain: aarch64-linux-android24
          - abi: x86_64
            goarch: amd64
            toolchain: x86_64-linux-android24

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Initialize Valid Submodules
        run: |
          # Only initialize the valid submodule (hev-socks5-tunnel)
          git submodule sync || true
          git submodule update --init app/src/main/jni/hev-socks5-tunnel || true

      - name: Read Versions
        run: |
          # Check if input version is provided (from workflow_call)
          INPUT_VERSION="${{ inputs.xray_version }}"
          
          if [ -f "version.properties" ]; then
            XRAY_VERSION=$(grep 'XRAY_CORE_VERSION' version.properties | cut -d '=' -f 2)
            GO_VERSION=$(grep 'GO_VERSION' version.properties | cut -d '=' -f 2)
            # Use input version if provided, otherwise use version.properties
            if [ -n "$INPUT_VERSION" ] && [ "$INPUT_VERSION" != "v25.10.15" ]; then
              XRAY_VERSION="$INPUT_VERSION"
            fi
            echo "XRAY_VERSION=$XRAY_VERSION" >> $GITHUB_ENV
            echo "GO_VERSION=$GO_VERSION" >> $GITHUB_ENV
          else
            # Use input version or default
            XRAY_VERSION="${INPUT_VERSION:-v25.10.15}"
            echo "XRAY_VERSION=$XRAY_VERSION" >> $GITHUB_ENV
            echo "GO_VERSION=1.25.3" >> $GITHUB_ENV
          fi
          
          echo "Building Xray-core version: $XRAY_VERSION"
          echo "Using Go version: $GO_VERSION"

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: Setup NDK
        run: |
          wget -qO android-ndk.zip https://dl.google.com/android/repository/android-ndk-r28c-linux.zip
          unzip -q android-ndk.zip
          rm android-ndk.zip
          NDK_HOME=$(realpath android-ndk-*)
          echo "NDK_HOME=$NDK_HOME" >> $GITHUB_ENV

      - name: Download BoringSSL Artifacts
        uses: actions/download-artifact@v4
        with:
          name: boringssl-${{ matrix.abi }}
          path: boringssl-${{ matrix.abi }}

      - name: Verify BoringSSL Artifacts Downloaded
        run: |
          ARTIFACT_DIR="boringssl-${{ matrix.abi }}"
          CRYPTO_LIB="$ARTIFACT_DIR/crypto/libcrypto.a"
          SSL_LIB="$ARTIFACT_DIR/ssl/libssl.a"
          
          echo "üîç Verifying downloaded BoringSSL artifacts..."
          
          if [ ! -f "$CRYPTO_LIB" ]; then
            echo "‚ùå libcrypto.a not found in downloaded artifacts"
            echo "Listing $ARTIFACT_DIR:"
            find "$ARTIFACT_DIR" -type f || echo "Directory does not exist"
            exit 1
          fi
          
          if [ ! -f "$SSL_LIB" ]; then
            echo "‚ùå libssl.a not found in downloaded artifacts"
            echo "Listing $ARTIFACT_DIR:"
            find "$ARTIFACT_DIR" -type f || echo "Directory does not exist"
            exit 1
          fi
          
          echo "‚úÖ Both artifacts downloaded successfully:"
          ls -lh "$CRYPTO_LIB" "$SSL_LIB"

      - name: Clone Xray-core
        run: |
          git clone --depth=1 https://github.com/XTLS/Xray-core.git
          cd Xray-core
          if [ -n "$XRAY_VERSION" ] && [ "$XRAY_VERSION" != "latest" ]; then
            git checkout "$XRAY_VERSION" || echo "‚ö†Ô∏è  Version $XRAY_VERSION not found, using latest"
          fi
          COMMIT=$(git rev-parse HEAD | cut -c 1-7)
          echo "XRAY_COMMIT=$COMMIT" >> $GITHUB_ENV
          echo "XRAY_COMMIT=$COMMIT" >> $GITHUB_OUTPUT

      - name: Apply Patches
        run: |
          cd Xray-core
          if [ -d "../xray-patches" ]; then
            for patch in ../xray-patches/*.patch; do
              if [ -f "$patch" ]; then
                echo "Applying patch: $(basename $patch)"
                git apply "$patch" || echo "‚ö†Ô∏è  Patch $(basename $patch) failed or already applied"
              fi
            done
          else
            echo "‚ö†Ô∏è  No patches directory found, building vanilla Xray-core"
          fi

      - name: Build Xray-core with BoringSSL
        run: |
          cd Xray-core
          
          # Set up CGO environment
          export GOOS=android
          export CGO_ENABLED=1
          export GOARCH=${{ matrix.goarch }}
          
          TOOLCHAIN_DIR="$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64"
          export CC=$TOOLCHAIN_DIR/bin/${{ matrix.toolchain }}-clang
          export CXX=$TOOLCHAIN_DIR/bin/${{ matrix.toolchain }}-clang++
          export AR=$TOOLCHAIN_DIR/bin/llvm-ar
          export RANLIB=$TOOLCHAIN_DIR/bin/llvm-ranlib
          export STRIP=$TOOLCHAIN_DIR/bin/llvm-strip
          
          # Set BoringSSL library paths
          BORINGSSL_CRYPTO="$(realpath ../boringssl-${{ matrix.abi }}/crypto/libcrypto.a)"
          BORINGSSL_SSL="$(realpath ../boringssl-${{ matrix.abi }}/ssl/libssl.a)"
          BORINGSSL_INCLUDE="$(realpath ../app/src/main/jni/perf-net/third_party/boringssl/include)"
          
          if [ ! -f "$BORINGSSL_CRYPTO" ] || [ ! -f "$BORINGSSL_SSL" ]; then
            echo "‚ùå BoringSSL libraries not found!"
            exit 1
          fi
          
          # CGO flags for BoringSSL
          export CGO_CFLAGS="-I$BORINGSSL_INCLUDE"
          export CGO_LDFLAGS="-L$(dirname $BORINGSSL_CRYPTO) -L$(dirname $BORINGSSL_SSL) -lcrypto -lssl -static"
          
          # Build Xray-core
          # Note: Without actual CGO bridge code in Xray-core, we build vanilla Xray
          # BoringSSL integration is handled by perf-net native module (already integrated)
          echo "Building Xray-core for ${{ matrix.abi }}..."
          
          # Try building with CGO if patches were applied, otherwise build vanilla
          if git diff --quiet HEAD; then
            echo "No patches applied, building vanilla Xray-core"
            go build \
              -o libxray.so \
              -trimpath \
              -buildvcs=false \
              -ldflags="-X github.com/xtls/xray-core/core.build=${XRAY_COMMIT} -s -w -buildid=" \
              -v \
              ./main
          else
            echo "Patches detected, attempting CGO build with BoringSSL..."
            go build \
              -buildmode=c-shared \
              -o libxray.so \
              -trimpath \
              -buildvcs=false \
              -ldflags="-X github.com/xtls/xray-core/core.build=${XRAY_COMMIT} -s -w -buildid=" \
              -v \
              ./main || {
                echo "‚ö†Ô∏è  CGO build failed, falling back to vanilla build"
                export CGO_ENABLED=0
                go build \
                  -o libxray.so \
                  -trimpath \
                  -buildvcs=false \
                  -ldflags="-X github.com/xtls/xray-core/core.build=${XRAY_COMMIT} -s -w -buildid=" \
                  -v \
                  ./main
              }
          fi
          
          # Strip binary
          $STRIP --strip-all libxray.so
          
          # Verify BoringSSL linkage
          if strings libxray.so | grep -qi "BoringSSL\|boringssl"; then
            echo "‚úÖ BoringSSL symbols found in binary"
          else
            echo "‚ö†Ô∏è  Warning: BoringSSL symbols not found in binary"
          fi
          
          # Move to output directory
          mkdir -p ../xray-output/${{ matrix.abi }}
          mv libxray.so ../xray-output/${{ matrix.abi }}/libxray.so

      - name: Upload Xray Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: xray-${{ matrix.abi }}
          path: xray-output/${{ matrix.abi }}/libxray.so
          retention-days: 7


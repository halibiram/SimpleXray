name: "Test Release"

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Release tag to use (e.g., v1.10.184). Leave empty to use latest successful release"
        required: false
        type: string
      test_version_suffix:
        description: "Test version suffix (e.g., -test1, -beta1)"
        required: false
        type: string
        default: "-test"

permissions:
  contents: write
  actions: read

jobs:
  create-test-release:
    name: Create Test Release from Latest APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup GitHub CLI
        run: |
          type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
          && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
          && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
          && sudo apt update \
          && sudo apt install gh -y

      - name: Authenticate GitHub CLI
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Find Successful Workflow Run with Artifacts
        id: find_workflow
        run: |
          echo "ðŸ” Finding successful Auto Release workflow run with artifacts..."
          
          # Get workflow file name
          WORKFLOW_FILE=".github/workflows/auto-release.yml"
          
          # Get successful workflow runs for auto-release workflow
          # Try different ways to find the workflow
          WORKFLOW_RUNS=$(gh run list --workflow="$WORKFLOW_FILE" --limit 20 --json databaseId,conclusion,createdAt,displayTitle --jq '.[] | select(.conclusion == "success") | "\(.databaseId)|\(.createdAt)|\(.displayTitle)"' 2>/dev/null || echo "")
          
          # If not found, try to find by workflow name pattern
          if [ -z "$WORKFLOW_RUNS" ]; then
            echo "âš ï¸  Not found by file name, trying to find by workflow runs..."
            # List all workflows to find the right one
            ALL_WORKFLOWS=$(gh workflow list --limit 50 --json name,id,path --jq '.[] | "\(.name)|\(.id)|\(.path)"' || echo "")
            echo "ðŸ“‹ Available workflows:"
            echo "$ALL_WORKFLOWS" | head -10
            
            # Try to find workflow with "release" in name
            RELEASE_WORKFLOW_ID=$(echo "$ALL_WORKFLOWS" | grep -i "release\|auto" | head -1 | cut -d'|' -f2 || echo "")
            if [ -n "$RELEASE_WORKFLOW_ID" ]; then
              echo "âœ… Found workflow ID: $RELEASE_WORKFLOW_ID"
              WORKFLOW_RUNS=$(gh run list --workflow="$RELEASE_WORKFLOW_ID" --limit 20 --json databaseId,conclusion,createdAt,displayTitle --jq '.[] | select(.conclusion == "success") | "\(.databaseId)|\(.createdAt)|\(.displayTitle)"' 2>/dev/null || echo "")
            fi
          fi
          
          # If still not found, try to get all successful runs and filter
          if [ -z "$WORKFLOW_RUNS" ]; then
            echo "âš ï¸  Trying to find any successful runs..."
            WORKFLOW_RUNS=$(gh run list --limit 50 --json databaseId,conclusion,createdAt,displayTitle,workflowName --jq '.[] | select(.conclusion == "success" and (.workflowName | test("release|auto"; "i"))) | "\(.databaseId)|\(.createdAt)|\(.displayTitle)"' 2>/dev/null || echo "")
          fi
          
          if [ -z "$WORKFLOW_RUNS" ]; then
            echo "âŒ No successful Auto Release workflow runs found"
            exit 1
          fi
          
          echo "ðŸ“‹ Found successful workflow runs:"
          echo "$WORKFLOW_RUNS" | head -5
          echo ""
          
          # Try to find a run with artifacts first
          FOUND_RUN_ID=""
          for run_info in $WORKFLOW_RUNS; do
            RUN_ID=$(echo "$run_info" | cut -d'|' -f1)
            CREATED_AT=$(echo "$run_info" | cut -d'|' -f2)
            TITLE=$(echo "$run_info" | cut -d'|' -f3-)
            
            echo "  Checking run $RUN_ID ($CREATED_AT)..."
            
            # Check if this run has artifacts
            ARTIFACTS=$(gh run view "$RUN_ID" --json artifacts --jq '.artifacts[] | .name' 2>/dev/null || echo "")
            
            if [ -n "$ARTIFACTS" ] && [ "$ARTIFACTS" != "" ]; then
              FOUND_RUN_ID="$RUN_ID"
              echo "âœ… Found successful run with artifacts: $RUN_ID"
              echo "   Artifacts: $(echo "$ARTIFACTS" | tr '\n' ' ')"
              break
            else
              echo "   No artifacts found"
            fi
          done
          
          # If no artifacts found, try to find release with APK from these runs
          if [ -z "$FOUND_RUN_ID" ]; then
            echo "âš ï¸  No artifacts found in workflow runs, checking releases..."
            
            # Get all releases and find one with APK
            ALL_RELEASES=$(gh release list --limit 20 --json tagName,createdAt --jq '.[] | "\(.tagName)|\(.createdAt)"' || echo "")
            
            if [ -z "$ALL_RELEASES" ]; then
              echo "âŒ No releases found"
              exit 1
            fi
            
            # Function to check if release has APK
            check_release_has_apk() {
              local tag=$1
              local release_info=$(gh release view "$tag" --json assets 2>/dev/null)
              local exit_code=$?
              
              if [ $exit_code -ne 0 ] || [ -z "$release_info" ]; then
                echo "âš ï¸  Failed to get release info for $tag" >&2
                return 1
              fi
              
              # Check if release has any assets
              local asset_count=$(echo "$release_info" | jq -r '.assets | length' 2>/dev/null || echo "0")
              if [ "$asset_count" = "0" ] || [ -z "$asset_count" ]; then
                return 1
              fi
              
              # Find APK asset
              local apk_asset=$(echo "$release_info" | jq -r '.assets[] | select(.name | endswith(".apk")) | .name' 2>/dev/null | head -1)
              
              if [ -n "$apk_asset" ] && [ "$apk_asset" != "null" ] && [ "$apk_asset" != "" ]; then
                echo "$apk_asset"
                return 0
              fi
              
              return 1
            }
            
            # Check each release for APK
            FOUND_RELEASE_TAG=""
            FOUND_APK_NAME=""
            for release_info in $ALL_RELEASES; do
              RELEASE_TAG=$(echo "$release_info" | cut -d'|' -f1)
              CREATED_AT=$(echo "$release_info" | cut -d'|' -f2)
              
              echo "  Checking release $RELEASE_TAG ($CREATED_AT)..."
              
              # Use set +e to continue on error
              set +e
              APK_ASSET=$(check_release_has_apk "$RELEASE_TAG" 2>&1)
              local check_exit=$?
              set -e
              
              if [ $check_exit -eq 0 ] && [ -n "$APK_ASSET" ]; then
                FOUND_RELEASE_TAG="$RELEASE_TAG"
                FOUND_APK_NAME="$APK_ASSET"
                echo "âœ… Found release with APK: $FOUND_RELEASE_TAG"
                echo "   APK: $FOUND_APK_NAME"
                break
              else
                if [ -n "$APK_ASSET" ] && echo "$APK_ASSET" | grep -q "âš ï¸"; then
                  echo "$APK_ASSET"
                else
                  echo "   No APK found in this release"
                fi
              fi
            done
            
            if [ -z "$FOUND_RELEASE_TAG" ]; then
              echo "âŒ No release with APK found"
              exit 1
            fi
            
            echo "release_tag=$FOUND_RELEASE_TAG" >> $GITHUB_OUTPUT
            echo "apk_name=$FOUND_APK_NAME" >> $GITHUB_OUTPUT
            echo "use_release=true" >> $GITHUB_OUTPUT
          else
            echo "run_id=$FOUND_RUN_ID" >> $GITHUB_OUTPUT
            echo "use_release=false" >> $GITHUB_OUTPUT
          fi

      - name: Download APK from Workflow Run or Release
        id: download_apk
        run: |
          USE_RELEASE="${{ steps.find_workflow.outputs.use_release }}"
          mkdir -p release-artifacts
          
          if [ "$USE_RELEASE" = "true" ]; then
            RELEASE_TAG="${{ steps.find_workflow.outputs.release_tag }}"
            APK_NAME="${{ steps.find_workflow.outputs.apk_name }}"
            
            echo "ðŸ“¥ Downloading APK from release $RELEASE_TAG..."
            
            # Download APK from release
            gh release download "$RELEASE_TAG" \
              --pattern "$APK_NAME" \
              --dir release-artifacts/ || {
              echo "âŒ Failed to download APK from release"
              exit 1
            }
            
            APK_FILE="release-artifacts/$APK_NAME"
          else
            RUN_ID="${{ steps.find_workflow.outputs.run_id }}"
            
            echo "ðŸ“¥ Downloading artifacts from workflow run $RUN_ID..."
            
            # Download all artifacts from the workflow run
            gh run download "$RUN_ID" --dir release-artifacts/ || {
              echo "âŒ Failed to download artifacts from workflow run"
              exit 1
            }
            
            # Find APK file in downloaded artifacts
            APK_FILE=$(find release-artifacts -name "*.apk" -type f | head -1)
            
            if [ -z "$APK_FILE" ]; then
              echo "âš ï¸  No APK file found in artifacts"
              echo "ðŸ“ Artifacts downloaded:"
              find release-artifacts -type f | head -10
              # Try to find any file that might be the APK
              APK_FILE=$(find release-artifacts -type f \( -name "*.apk" -o -name "*simplexray*" \) | head -1)
            fi
            
            if [ -z "$APK_FILE" ]; then
              echo "âŒ No suitable APK file found"
              exit 1
            fi
            
            APK_NAME=$(basename "$APK_FILE")
          fi
          
          # Verify APK file exists
          if [ -f "$APK_FILE" ]; then
            APK_SIZE=$(stat -c%s "$APK_FILE" 2>/dev/null || echo "0")
            APK_SIZE_MB=$((APK_SIZE / 1024 / 1024))
            echo "âœ… APK found: $APK_NAME (${APK_SIZE_MB}MB)"
            echo "apk_name=$APK_NAME" >> $GITHUB_OUTPUT
            echo "apk_path=$APK_FILE" >> $GITHUB_OUTPUT
          else
            echo "âŒ APK file not found: $APK_FILE"
            exit 1
          fi
          
          echo ""
          echo "ðŸ“¦ All files in release-artifacts/:"
          ls -lh release-artifacts/

      - name: Read Version from Properties
        id: version
        run: |
          if [ -f "version.properties" ]; then
            VERSION_NAME=$(grep 'APP_VERSION_NAME' version.properties | cut -d '=' -f 2)
            VERSION_CODE=$(grep 'APP_VERSION_CODE' version.properties | cut -d '=' -f 2)
          else
            # Use current date as version if properties not found
            VERSION_NAME=$(date +"%Y.%m.%d")
            VERSION_CODE="1"
          fi
          
          TEST_SUFFIX="${{ inputs.test_version_suffix }}"
          TEST_VERSION_NAME="${VERSION_NAME}${TEST_SUFFIX}"
          
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "test_version_name=$TEST_VERSION_NAME" >> $GITHUB_OUTPUT
          echo "tag=v${TEST_VERSION_NAME}" >> $GITHUB_OUTPUT
          
          echo "ðŸ“‹ Version Information:"
          echo "  Original Version: $VERSION_NAME"
          echo "  Test Version: $TEST_VERSION_NAME"
          echo "  Test Tag: v${TEST_VERSION_NAME}"

      - name: Check if Test Tag Exists
        id: check_tag
        run: |
          TEST_TAG="v${{ steps.version.outputs.test_version_name }}"
          if git ls-remote --tags origin | grep -q "refs/tags/${TEST_TAG}$"; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âš ï¸  Tag $TEST_TAG already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âœ… Tag $TEST_TAG does not exist, proceeding"
          fi

      - name: Create Test Release
        if: steps.check_tag.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TEST_TAG="v${{ steps.version.outputs.test_version_name }}"
          USE_RELEASE="${{ steps.find_workflow.outputs.use_release }}"
          VERSION_NAME="${{ steps.version.outputs.test_version_name }}"
          BUILD_CODE="${{ steps.version.outputs.version_code }}"
          COMMIT="${{ github.sha }}"
          APK_PATH="${{ steps.download_apk.outputs.apk_path }}"
          APK_NAME="${{ steps.download_apk.outputs.apk_name }}"
          
          if [ "$USE_RELEASE" = "true" ]; then
            SOURCE_INFO="Release ${{ steps.find_workflow.outputs.release_tag }}"
          else
            SOURCE_INFO="Workflow Run ${{ steps.find_workflow.outputs.run_id }}"
          fi
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create and push tag
          git tag -a "$TEST_TAG" -m "Test Release $TEST_TAG (from $SOURCE_INFO)"
          git push origin "$TEST_TAG"
          
          # Create release notes
          cat > release_notes.md << EOF
          ðŸ§ª Test Release for version ${VERSION_NAME}
          
          **Source:** ${SOURCE_INFO}
          **Test Version:** ${TEST_VERSION_NAME}
          **Build Code:** ${BUILD_CODE}
          **Commit:** ${COMMIT}
          
          **Note:** This is a test release created from ${SOURCE_INFO}.
          No new build was performed - using existing APK.
          
          **Download APK:**
          - \`${APK_NAME}\` - For most modern devices (ARM64) - BoringSSL optimized
          
          **Features:**
          - ðŸ”’ BoringSSL integration (replaces OpenSSL)
          - âš¡ Hardware-accelerated crypto (AES-GCM, ChaCha20-Poly1305)
          - ðŸš€ TLS 1.3 with Chrome mobile fingerprint mimic
          - ðŸ“¡ QUIC/HTTP3 support
          - ðŸŽ¯ Xray-core built with BoringSSL (3-40x faster crypto performance)
          - ðŸŒŠ Hysteria2 QUIC acceleration (standalone or chain mode)
          
          ---
          ðŸ¤– Auto-generated test release from ${SOURCE_INFO}
          EOF
          
          # Create release with APK
          if [ -n "$APK_PATH" ] && [ -f "$APK_PATH" ]; then
            echo "ðŸ“¦ Creating test release with APK..."
            gh release create "$TEST_TAG" \
              --title "SimpleXray Test Release $TEST_TAG" \
              --notes-file release_notes.md \
              --prerelease \
              "$APK_PATH"
            
            echo "âœ… Test release created: https://github.com/${{ github.repository }}/releases/tag/$TEST_TAG"
          else
            echo "âŒ APK file not found: $APK_PATH"
            echo "ðŸ“ Available files in release-artifacts/:"
            ls -lah release-artifacts/ || echo "Directory does not exist"
            exit 1
          fi

      - name: Send Test Release Notification to Telegram
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
          CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
          
          if [ -z "$BOT_TOKEN" ] || [ -z "$CHAT_ID" ]; then
            echo "âš ï¸  Telegram secrets not configured, skipping notification"
            exit 0
          fi
          
          TEST_TAG="v${{ steps.version.outputs.test_version_name }}"
          USE_RELEASE="${{ steps.find_workflow.outputs.use_release }}"
          RELEASE_URL="https://github.com/${{ github.repository }}/releases/tag/$TEST_TAG"
          
          if [ "$USE_RELEASE" = "true" ]; then
            SOURCE_TEXT="Release ${{ steps.find_workflow.outputs.release_tag }}"
          else
            SOURCE_TEXT="Workflow Run ${{ steps.find_workflow.outputs.run_id }}"
          fi
          
          TEXT="ðŸ§ª *Test Release Created*\n\nðŸ“¦ *Version:* $TEST_TAG\nðŸ“‹ *Source:* $SOURCE_TEXT\nðŸ”¨ *Build:* ${{ steps.version.outputs.version_code }}\n\nâ„¹ï¸ *Note:* This is a test release using APK from $SOURCE_TEXT. No new build was performed.\n\nðŸ”— [Download Test Release]($RELEASE_URL)"
          
          curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "{\"chat_id\": \"$CHAT_ID\", \"text\": \"$TEXT\", \"parse_mode\": \"Markdown\"}" \
            "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" || echo "âš ï¸  Failed to send Telegram notification"


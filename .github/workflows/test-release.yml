name: "Test Release"

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Release tag to use (e.g., v1.10.184). Leave empty to use latest successful release"
        required: false
        type: string
      test_version_suffix:
        description: "Test version suffix (e.g., -test1, -beta1)"
        required: false
        type: string
        default: "-test"

permissions:
  contents: write
  actions: read

jobs:
  create-test-release:
    name: Create Test Release from Latest APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup GitHub CLI
        run: |
          type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
          && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
          && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
          && sudo apt update \
          && sudo apt install gh -y

      - name: Authenticate GitHub CLI
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Find Successful Workflow Run with Artifacts
        id: find_workflow
        run: |
          echo "ðŸ” Finding successful Auto Release workflow run with artifacts..."
          
          # Get successful workflow runs for "Auto Release" workflow
          WORKFLOW_RUNS=$(gh run list --workflow="Auto Release" --limit 20 --json databaseId,conclusion,createdAt,displayTitle --jq '.[] | select(.conclusion == "success") | "\(.databaseId)|\(.createdAt)|\(.displayTitle)"' || echo "")
          
          if [ -z "$WORKFLOW_RUNS" ]; then
            echo "âŒ No successful Auto Release workflow runs found"
            exit 1
          fi
          
          echo "ðŸ“‹ Found successful workflow runs:"
          echo "$WORKFLOW_RUNS" | head -5
          echo ""
          
          # Try to find a run with artifacts
          FOUND_RUN_ID=""
          for run_info in $WORKFLOW_RUNS; do
            RUN_ID=$(echo "$run_info" | cut -d'|' -f1)
            CREATED_AT=$(echo "$run_info" | cut -d'|' -f2)
            TITLE=$(echo "$run_info" | cut -d'|' -f3)
            
            echo "  Checking run $RUN_ID ($CREATED_AT)..."
            
            # Check if this run has artifacts
            ARTIFACTS=$(gh run view "$RUN_ID" --json artifacts --jq '.artifacts[] | .name' 2>/dev/null || echo "")
            
            if [ -n "$ARTIFACTS" ]; then
              FOUND_RUN_ID="$RUN_ID"
              echo "âœ… Found successful run with artifacts: $RUN_ID"
              echo "   Artifacts: $(echo "$ARTIFACTS" | tr '\n' ' ')"
              break
            else
              echo "   No artifacts found"
            fi
          done
          
          if [ -z "$FOUND_RUN_ID" ]; then
            echo "âŒ No successful workflow run with artifacts found"
            exit 1
          fi
          
          echo "run_id=$FOUND_RUN_ID" >> $GITHUB_OUTPUT
          
          # Get release tag from workflow run if available
          RUN_INFO=$(gh run view "$FOUND_RUN_ID" --json displayTitle,headBranch --jq '{title: .displayTitle, branch: .headBranch}' 2>/dev/null || echo "")
          echo "ðŸ“‹ Workflow run info:"
          echo "$RUN_INFO"

      - name: Download Artifacts from Workflow Run
        run: |
          RUN_ID="${{ steps.find_workflow.outputs.run_id }}"
          
          echo "ðŸ“¥ Downloading artifacts from workflow run $RUN_ID..."
          
          mkdir -p release-artifacts
          
          # Download all artifacts from the workflow run
          gh run download "$RUN_ID" --dir release-artifacts/ || {
            echo "âŒ Failed to download artifacts from workflow run"
            exit 1
          }
          
          # Find APK file in downloaded artifacts
          APK_FILE=$(find release-artifacts -name "*.apk" -type f | head -1)
          
          if [ -n "$APK_FILE" ]; then
            APK_NAME=$(basename "$APK_FILE")
            APK_SIZE=$(stat -c%s "$APK_FILE" 2>/dev/null || echo "0")
            APK_SIZE_MB=$((APK_SIZE / 1024 / 1024))
            echo "âœ… APK found in artifacts: $APK_NAME (${APK_SIZE_MB}MB)"
            echo "apk_name=$APK_NAME" >> $GITHUB_OUTPUT
            echo "apk_path=$APK_FILE" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸  No APK file found in artifacts, but continuing..."
            echo "ðŸ“ Artifacts downloaded:"
            find release-artifacts -type f | head -10
            # Try to find any file that might be the APK
            APK_FILE=$(find release-artifacts -type f \( -name "*.apk" -o -name "*simplexray*" \) | head -1)
            if [ -n "$APK_FILE" ]; then
              APK_NAME=$(basename "$APK_FILE")
              echo "âœ… Using file: $APK_NAME"
              echo "apk_name=$APK_NAME" >> $GITHUB_OUTPUT
              echo "apk_path=$APK_FILE" >> $GITHUB_OUTPUT
            else
              echo "âŒ No suitable APK file found"
              exit 1
            fi
          fi
          
          echo ""
          echo "ðŸ“¦ All artifacts:"
          ls -lh release-artifacts/

      - name: Read Version from Properties
        id: version
        run: |
          if [ -f "version.properties" ]; then
            VERSION_NAME=$(grep 'APP_VERSION_NAME' version.properties | cut -d '=' -f 2)
            VERSION_CODE=$(grep 'APP_VERSION_CODE' version.properties | cut -d '=' -f 2)
          else
            # Use current date as version if properties not found
            VERSION_NAME=$(date +"%Y.%m.%d")
            VERSION_CODE="1"
          fi
          
          TEST_SUFFIX="${{ inputs.test_version_suffix }}"
          TEST_VERSION_NAME="${VERSION_NAME}${TEST_SUFFIX}"
          
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "test_version_name=$TEST_VERSION_NAME" >> $GITHUB_OUTPUT
          echo "tag=v${TEST_VERSION_NAME}" >> $GITHUB_OUTPUT
          
          echo "ðŸ“‹ Version Information:"
          echo "  Original Version: $VERSION_NAME"
          echo "  Test Version: $TEST_VERSION_NAME"
          echo "  Test Tag: v${TEST_VERSION_NAME}"

      - name: Check if Test Tag Exists
        id: check_tag
        run: |
          TEST_TAG="v${{ steps.version.outputs.test_version_name }}"
          if git ls-remote --tags origin | grep -q "refs/tags/${TEST_TAG}$"; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âš ï¸  Tag $TEST_TAG already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âœ… Tag $TEST_TAG does not exist, proceeding"
          fi

      - name: Create Test Release
        if: steps.check_tag.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TEST_TAG="v${{ steps.version.outputs.test_version_name }}"
          RUN_ID="${{ steps.find_workflow.outputs.run_id }}"
          VERSION_NAME="${{ steps.version.outputs.test_version_name }}"
          BUILD_CODE="${{ steps.version.outputs.version_code }}"
          COMMIT="${{ github.sha }}"
          APK_PATH="${{ steps.find_workflow.outputs.apk_path }}"
          APK_NAME="${{ steps.find_workflow.outputs.apk_name }}"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create and push tag
          git tag -a "$TEST_TAG" -m "Test Release $TEST_TAG (from workflow run $RUN_ID)"
          git push origin "$TEST_TAG"
          
          # Create release notes
          cat > release_notes.md << EOF
          ðŸ§ª Test Release for version ${VERSION_NAME}
          
          **Source Workflow Run:** ${RUN_ID}
          **Test Version:** ${TEST_VERSION_NAME}
          **Build Code:** ${BUILD_CODE}
          **Commit:** ${COMMIT}
          
          **Note:** This is a test release created from artifacts of successful Auto Release workflow run ${RUN_ID}.
          No new build was performed - using existing artifacts from the successful workflow run.
          
          **Download APK:**
          - \`${APK_NAME}\` - For most modern devices (ARM64) - BoringSSL optimized
          
          **Features:**
          - ðŸ”’ BoringSSL integration (replaces OpenSSL)
          - âš¡ Hardware-accelerated crypto (AES-GCM, ChaCha20-Poly1305)
          - ðŸš€ TLS 1.3 with Chrome mobile fingerprint mimic
          - ðŸ“¡ QUIC/HTTP3 support
          - ðŸŽ¯ Xray-core built with BoringSSL (3-40x faster crypto performance)
          - ðŸŒŠ Hysteria2 QUIC acceleration (standalone or chain mode)
          
          ---
          ðŸ¤– Auto-generated test release from workflow run ${RUN_ID}
          EOF
          
          # Create release with APK
          if [ -n "$APK_PATH" ] && [ -f "$APK_PATH" ]; then
            echo "ðŸ“¦ Creating test release with APK..."
            gh release create "$TEST_TAG" \
              --title "SimpleXray Test Release $TEST_TAG" \
              --notes-file release_notes.md \
              --prerelease \
              "$APK_PATH"
            
            echo "âœ… Test release created: https://github.com/${{ github.repository }}/releases/tag/$TEST_TAG"
          else
            echo "âŒ APK file not found: $APK_PATH"
            echo "ðŸ“ Available files in release-artifacts/:"
            ls -lah release-artifacts/ || echo "Directory does not exist"
            exit 1
          fi

      - name: Send Test Release Notification to Telegram
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
          CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
          
          if [ -z "$BOT_TOKEN" ] || [ -z "$CHAT_ID" ]; then
            echo "âš ï¸  Telegram secrets not configured, skipping notification"
            exit 0
          fi
          
          TEST_TAG="v${{ steps.version.outputs.test_version_name }}"
          RUN_ID="${{ steps.find_workflow.outputs.run_id }}"
          RELEASE_URL="https://github.com/${{ github.repository }}/releases/tag/$TEST_TAG"
          
          TEXT="ðŸ§ª *Test Release Created*\n\nðŸ“¦ *Version:* $TEST_TAG\nðŸ“‹ *Source:* Workflow Run $RUN_ID\nðŸ”¨ *Build:* ${{ steps.version.outputs.version_code }}\n\nâ„¹ï¸ *Note:* This is a test release using artifacts from successful workflow run. No new build was performed.\n\nðŸ”— [Download Test Release]($RELEASE_URL)"
          
          curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "{\"chat_id\": \"$CHAT_ID\", \"text\": \"$TEXT\", \"parse_mode\": \"Markdown\"}" \
            "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" || echo "âš ï¸  Failed to send Telegram notification"


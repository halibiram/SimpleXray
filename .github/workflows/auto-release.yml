name: "Auto Release"

on:
  push:
    branches:
      - main
    paths:
      - "app/**"
      - "xray-patches/**"
      - "scripts/**"
      - ".github/workflows/**"
  workflow_dispatch:
    inputs:
      with_boringssl:
        description: "Enable BoringSSL"
        type: boolean
        default: true
      xray_version:
        description: "Xray-core version"
        default: "latest"

jobs:
  build-xray-libs:
    name: Build Xray-core with BoringSSL
    uses: ./.github/workflows/build-xray-boringssl.yml
    if: |
      github.event.inputs.with_boringssl != 'false' &&
      (github.event_name == 'workflow_dispatch' || github.event_name == 'push')
    secrets: inherit

  build-and-release:
    name: Build and Auto Release
    runs-on: ubuntu-latest
    needs: [build-xray-libs]
    if: always() && (needs.build-xray-libs.result == 'success' || needs.build-xray-libs.result == 'skipped')

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: Initialize Valid Submodules
        run: |
          # Only initialize the valid submodule (hev-socks5-tunnel)
          git submodule sync || true
          git submodule update --init app/src/main/jni/hev-socks5-tunnel || true
          echo "âœ… Submodules initialized"

      - name: Read Versions
        id: version
        run: |
          VERSION_NAME=$(grep 'APP_VERSION_NAME' version.properties | cut -d '=' -f 2)
          VERSION_CODE=$(grep 'APP_VERSION_CODE' version.properties | cut -d '=' -f 2)
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION_NAME" >> $GITHUB_OUTPUT

          echo "XRAY_VERSION=$(grep 'XRAY_CORE_VERSION' version.properties | cut -d '=' -f 2)" >> $GITHUB_ENV
          echo "GEOIP_VERSION=$(grep 'GEOIP_VERSION' version.properties | cut -d '=' -f 2)" >> $GITHUB_ENV
          echo "GEOSITE_VERSION=$(grep 'GEOSITE_VERSION' version.properties | cut -d '=' -f 2)" >> $GITHUB_ENV
          echo "GO_VERSION=$(grep 'GO_VERSION' version.properties | cut -d '=' -f 2)" >> $GITHUB_ENV
          # OPENSSL_VERSION no longer needed - using BoringSSL

      - name: Check if tag exists
        id: check_tag
        run: |
          if git ls-remote --tags origin | grep -q "refs/tags/v${{ steps.version.outputs.version_name }}$"; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âš ï¸  Tag v${{ steps.version.outputs.version_name }} already exists, skipping release"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âœ… Tag v${{ steps.version.outputs.version_name }} does not exist, proceeding with build"
          fi

      - name: Set up Java 21
        if: steps.check_tag.outputs.exists == 'false'
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"
          cache: "gradle"

      - name: Set up Android SDK
        if: steps.check_tag.outputs.exists == 'false'
        uses: android-actions/setup-android@v3

      - name: Install CMake
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          echo "y" | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "cmake;3.22.1"
          echo "âœ… CMake 3.22.1 installed"

      - name: Set up Go
        if: steps.check_tag.outputs.exists == 'false'
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: Setup Keystore and Properties
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          echo "${{ secrets.SIGNING_KEYSTORE }}" > keystore.b64
          base64 -d keystore.b64 > ./store.jks
          rm keystore.b64
          echo "storeFile=store.jks" > ./store.properties
          echo "storePassword=${{ secrets.SIGNING_STORE_PASSWORD }}" >> ./store.properties
          echo "keyAlias=${{ secrets.SIGNING_KEY_ALIAS }}" >> ./store.properties
          echo "keyPassword=${{ secrets.SIGNING_KEY_PASSWORD }}" >> ./store.properties

      - name: Download Rules Files
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          wget https://github.com/lhear/v2ray-rules-dat/releases/download/${{ env.GEOIP_VERSION }}/geoip.dat -O ./app/src/main/assets/geoip.dat
          wget https://github.com/lhear/v2ray-rules-dat/releases/download/${{ env.GEOSITE_VERSION }}/geosite.dat -O ./app/src/main/assets/geosite.dat

      - name: Download Custom Xray Libraries
        if: steps.check_tag.outputs.exists == 'false' && needs.build-xray-libs.result == 'success'
        uses: actions/download-artifact@v4
        with:
          path: xray-libs
          pattern: xray-*
          merge-multiple: true

      - name: Replace Xray Binaries
        if: steps.check_tag.outputs.exists == 'false' && needs.build-xray-libs.result == 'success'
        run: |
          echo "ðŸ“¦ Replacing Xray binaries with BoringSSL-enabled versions..."

          # Remove old binaries if they exist
          rm -f app/src/main/jniLibs/*/libxray.so

          # Copy new BoringSSL-enabled binaries
          for abi in arm64-v8a armeabi-v7a x86_64; do
            if [ -f "xray-libs/xray-$abi/libxray.so" ]; then
              mkdir -p app/src/main/jniLibs/$abi
              cp xray-libs/xray-$abi/libxray.so app/src/main/jniLibs/$abi/libxray.so
              echo "âœ… Copied BoringSSL-enabled Xray for $abi"
            else
              echo "âš ï¸  BoringSSL-enabled Xray not found for $abi, will use vanilla build"
            fi
          done

          # Verify
          echo "ðŸ“‹ Verifying Xray binaries:"
          ls -lh app/src/main/jniLibs/*/libxray.so 2>/dev/null || echo "âš ï¸  No Xray binaries found"

      - name: Build Xray-core from Source (Fallback)
        if: steps.check_tag.outputs.exists == 'false' && needs.build-xray-libs.result != 'success'
        run: |
          echo "âš ï¸  BoringSSL build failed, using vanilla Xray-core build..."
          wget -qO android-ndk.zip https://dl.google.com/android/repository/android-ndk-r28c-linux.zip
          unzip -q android-ndk.zip
          rm android-ndk.zip
          NDK_HOME=$(realpath android-ndk-*)

          git clone https://github.com/XTLS/Xray-core.git
          cd Xray-core
          git checkout ${{ env.XRAY_VERSION }}
          COMMID=$(git rev-parse HEAD | cut -c 1-7)

          export GOOS=android
          export CGO_ENABLED=1

          echo "Building for arm64-v8a..."
          export GOARCH=arm64
          export CC=$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android24-clang
          go build -o xray -trimpath -buildvcs=false -ldflags="-X github.com/xtls/xray-core/core.build=${COMMID} -s -w -buildid=" -v ./main
          mkdir -p ../app/src/main/jniLibs/arm64-v8a
          mv xray ../app/src/main/jniLibs/arm64-v8a/libxray.so

          echo "Building for x86_64..."
          export GOARCH=amd64
          export CC=$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android24-clang
          go build -o xray -trimpath -buildvcs=false -ldflags="-X github.com/xtls/xray-core/core.build=${COMMID} -s -w -buildid=" -v ./main
          mkdir -p ../app/src/main/jniLibs/x86_64
          mv xray ../app/src/main/jniLibs/x86_64/libxray.so

      - name: Verify BoringSSL Integration
        if: steps.check_tag.outputs.exists == 'false' && needs.build-xray-libs.result == 'success'
        run: |
          echo "ðŸ” Verifying BoringSSL integration..."

          for abi in arm64-v8a armeabi-v7a x86_64; do
            BINARY="app/src/main/jniLibs/$abi/libxray.so"
            if [ -f "$BINARY" ]; then
              echo "Checking $abi..."
              if strings "$BINARY" | grep -qi "BoringSSL\|boringssl"; then
                echo "  âœ… BoringSSL symbols found in $abi"
              else
                echo "  âš ï¸  No BoringSSL symbols found in $abi"
              fi
              
              if strings "$BINARY" | grep -qi "aes.*gcm\|EVP_aes"; then
                echo "  âœ… AES-GCM symbols found in $abi"
              fi
            fi
          done

      - name: Make gradlew executable
        if: steps.check_tag.outputs.exists == 'false'
        run: chmod +x ./gradlew

      - name: Setup Google Services JSON
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          # Ensure google-services.json exists in the app directory
          if [ -f "./app/google-services.json" ]; then
            echo "âœ… google-services.json found at app/google-services.json"
            # Also copy to variant-specific location for release build
            mkdir -p ./app/src/release
            cp ./app/google-services.json ./app/src/release/google-services.json
            echo "âœ… Copied google-services.json to app/src/release/"
          else
            echo "âš ï¸  google-services.json not found, creating a minimal template"
            mkdir -p ./app/src/release
            printf '%s\n' \
              '{' \
              '  "project_info": {' \
              '    "project_number": "123456789000",' \
              '    "project_id": "simplexray-template",' \
              '    "storage_bucket": "simplexray-template.appspot.com"' \
              '  },' \
              '  "client": [' \
              '    {' \
              '      "client_info": {' \
              '        "mobilesdk_app_id": "1:123456789000:android:0000000000000000000000",' \
              '        "android_client_info": {' \
              '          "package_name": "com.simplexray.an"' \
              '        }' \
              '      },' \
              '      "oauth_client": [],' \
              '      "api_key": [' \
              '        {' \
              '          "current_key": "AIzaSyDummy-Key-Replace-With-Real-Firebase-Key"' \
              '        }' \
              '      ],' \
              '      "services": {' \
              '        "appinvite_service": {' \
              '          "other_platform_oauth_client": []' \
              '        }' \
              '      }' \
              '    }' \
              '  ],' \
              '  "configuration_version": "1"' \
              '}' > ./app/src/release/google-services.json
            echo "âœ… Created minimal google-services.json template"
          fi

      - name: Build Release APK
        if: steps.check_tag.outputs.exists == 'false'
        run: ./gradlew assembleRelease

      - name: Find and Copy APKs
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          mkdir -p release-artifacts
          find app/build -name "*.apk" -type f -exec cp {} release-artifacts/ \;
          echo "=== APKs copied to release-artifacts/ ==="
          ls -lah release-artifacts/

      - name: Create Release
        if: steps.check_tag.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="v${{ steps.version.outputs.version_name }}"
          VERSION="${{ steps.version.outputs.version_name }}"
          BUILD="${{ steps.version.outputs.version_code }}"
          COMMIT="${{ github.sha }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"

          cat > release_notes.md << EOF
          ðŸš€ Automatic release for version ${VERSION}

          **Build Information:**
          - Version: ${VERSION}
          - Build Code: ${BUILD}
          - Commit: ${COMMIT}

          **Download APKs:**
          - \`simplexray-arm64-v8a.apk\` - For most modern devices (ARM64) - BoringSSL optimized

          **Features:**
          - ðŸ”’ BoringSSL integration (replaces OpenSSL)
          - âš¡ Hardware-accelerated crypto (AES-GCM, ChaCha20-Poly1305)
          - ðŸš€ TLS 1.3 with Chrome mobile fingerprint mimic
          - ðŸ“¡ QUIC/HTTP3 support
          - ðŸŽ¯ Xray-core built with BoringSSL (3-40x faster crypto performance)

          **Changes:**
          See commit history for detailed changes.

          ---
          ðŸ¤– Auto-generated release
          EOF

          # Only upload arm64-v8a APK (BoringSSL optimized for ARM64)
          if [ -f "release-artifacts/simplexray-arm64-v8a.apk" ]; then
            gh release create "$TAG" \
              --title "SimpleXray $TAG" \
              --notes-file release_notes.md \
              release-artifacts/simplexray-arm64-v8a.apk
          else
            echo "âš ï¸  APK not found, creating release without APK"
            gh release create "$TAG" \
              --title "SimpleXray $TAG" \
              --notes-file release_notes.md
          fi

      - name: Send Release Notification to Telegram
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
          CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"

          if [ -z "$BOT_TOKEN" ] || [ -z "$CHAT_ID" ]; then
            echo "âš ï¸  Telegram secrets not configured"
            exit 0
          fi

          TAG="v${{ steps.version.outputs.version_name }}"
          RELEASE_URL="https://github.com/${{ github.repository }}/releases/tag/$TAG"

          BORINGSSL_STATUS=""
          if [ "${{ needs.build-xray-libs.result }}" == "success" ]; then
            BORINGSSL_STATUS="\\nðŸš€ *Xray-core:* BoringSSL Enabled\\nâš¡ *Performance:* 3-40x faster crypto"
          fi

          TEXT="ðŸŽ‰ *New SimpleXray Release*\\n\\nðŸ“¦ *Version:* $TAG\\nðŸ”¨ *Build:* ${{ steps.version.outputs.version_code }}$BORINGSSL_STATUS\\nðŸ”— [Download Now]($RELEASE_URL)\\n\\nâœ¨ Auto-update available in app!"

          curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "{\"chat_id\": \"$CHAT_ID\", \"text\": \"$TEXT\", \"parse_mode\": \"Markdown\"}" \
            "https://api.telegram.org/bot$BOT_TOKEN/sendMessage"

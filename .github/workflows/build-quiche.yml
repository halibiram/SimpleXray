name: Build QUICHE Native Client

on:
  workflow_call:
    inputs:
      quiche_version:
        description: "QUICHE version/commit to build"
        required: false
        type: string
        default: "latest"
  workflow_dispatch:
    inputs:
      quiche_version:
        description: "QUICHE version/commit to build"
        required: false
        default: "latest"
      build_abis:
        description: "Comma-separated ABIs to build"
        required: false
        default: "arm64-v8a,x86_64"

jobs:
  build:
    name: Build QUICHE
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        abi: [arm64-v8a, x86_64]
        include:
          - abi: arm64-v8a
            rust_target: aarch64-linux-android
          - abi: x86_64
            rust_target: x86_64-linux-android

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 1

      - name: Initialize QUICHE Submodule
        run: |
          echo "üì¶ Initializing QUICHE submodule with all nested submodules..."
          QUICHE_DIR="app/src/main/jni/quiche-client/third_party/quiche"
          
          # First, ensure the parent directory exists
          mkdir -p "$(dirname "$QUICHE_DIR")"
          
          # Initialize QUICHE submodule recursively to get BoringSSL and other deps
          echo "üì• Initializing QUICHE submodule recursively..."
          git submodule sync --recursive || true
          git submodule update --init --recursive app/src/main/jni/quiche-client/third_party/quiche || {
            echo "‚ö†Ô∏è  Submodule update failed, trying manual clone..."
            # If submodule update fails, clone manually
            if [ -d "$QUICHE_DIR" ]; then
              rm -rf "$QUICHE_DIR"
            fi
            git clone --depth=1 --recursive https://github.com/cloudflare/quiche.git "$QUICHE_DIR" || {
              echo "‚ùå Failed to clone QUICHE"
              exit 1
            }
          }
          
          # Verify QUICHE directory exists
          if [ ! -d "$QUICHE_DIR" ]; then
            echo "‚ùå QUICHE directory does not exist after initialization"
            echo "üìÅ Parent directory contents:"
            ls -la "$(dirname "$QUICHE_DIR")" || echo "Parent directory does not exist"
            exit 1
          fi
          
          # Ensure we're in the repo root for submodule operations
          cd "$QUICHE_DIR"
          
          # Ensure nested submodules are initialized (especially BoringSSL)
          echo "üì• Initializing nested submodules..."
          git submodule update --init --recursive || {
            echo "‚ö†Ô∏è  Nested submodule update failed, trying to fix..."
            # Try to initialize BoringSSL specifically
            if [ -f ".gitmodules" ]; then
              git submodule sync --recursive
              git submodule update --init --recursive
            fi
          }
          
          # Go back to repo root
          cd "$GITHUB_WORKSPACE"
          
          # Verify QUICHE structure
          if [ -f "$QUICHE_DIR/quiche/Cargo.toml" ]; then
            echo "‚úÖ QUICHE structure verified"
            echo "üìÅ QUICHE directory: $QUICHE_DIR"
            echo "üìÅ QUICHE contents:"
            ls -la "$QUICHE_DIR" | head -15
            
            # Verify BoringSSL submodule exists (required for QUICHE build)
            if [ -d "$QUICHE_DIR/quiche/deps/boringssl" ] && [ -f "$QUICHE_DIR/quiche/deps/boringssl/CMakeLists.txt" ]; then
              echo "‚úÖ BoringSSL submodule found and initialized"
              echo "üìÅ BoringSSL CMakeLists.txt exists"
            else
              echo "‚ö†Ô∏è  BoringSSL submodule missing or incomplete"
              echo "üìÅ Contents of $QUICHE_DIR/quiche/deps:"
              ls -la "$QUICHE_DIR/quiche/deps/" 2>/dev/null || echo "deps directory does not exist"
              echo "üìÅ Contents of $QUICHE_DIR/quiche:"
              ls -la "$QUICHE_DIR/quiche/" 2>/dev/null || echo "quiche directory does not exist"
              echo "‚ùå BoringSSL is required for QUICHE build"
              exit 1
            fi
          else
            echo "‚ùå QUICHE structure invalid - quiche/Cargo.toml not found"
            echo "üìÅ Contents of $QUICHE_DIR:"
            ls -la "$QUICHE_DIR" || echo "QUICHE directory does not exist"
            echo "üìÅ Looking for Cargo.toml files:"
            find "$QUICHE_DIR" -name "Cargo.toml" -type f 2>/dev/null | head -5 || echo "No Cargo.toml files found"
            exit 1
          fi

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build
          cmake --version
          ninja --version

      - name: Install cargo-ndk
        run: |
          if ! command -v cargo-ndk &> /dev/null; then
            echo "üì¶ Installing cargo-ndk..."
            cargo install cargo-ndk
          else
            echo "‚úÖ cargo-ndk already installed"
            cargo-ndk --version
          fi

      - name: Add Rust Android Targets
        run: |
          echo "üì¶ Adding Rust Android targets..."
          rustup target add ${{ matrix.rust_target }} || true
          rustup target list --installed | grep android || echo "‚ö†Ô∏è  No Android targets found"

      - name: Setup NDK
        run: |
          wget -qO android-ndk.zip https://dl.google.com/android/repository/android-ndk-r28c-linux.zip
          unzip -q android-ndk.zip
          rm android-ndk.zip
          NDK_HOME=$(realpath android-ndk-*)
          echo "NDK_HOME=$NDK_HOME" >> $GITHUB_ENV
          echo "NDK version: $(cat $NDK_HOME/source.properties | grep Pkg.Revision | cut -d'=' -f2)"

      - name: Configure cargo-ndk
        run: |
          # Set ANDROID_NDK_HOME for cargo-ndk
          echo "ANDROID_NDK_HOME=$NDK_HOME" >> $GITHUB_ENV
          
          # Verify cargo-ndk can find NDK
          cargo ndk --help || {
            echo "‚ùå cargo-ndk not working"
            exit 1
          }

      - name: Build QUICHE for ${{ matrix.abi }}
        run: |
          QUICHE_DIR="app/src/main/jni/quiche-client/third_party/quiche"
          OUTPUT_DIR="app/src/main/jni/quiche-client/libs"
          
          # Verify QUICHE directory exists
          if [ ! -d "$QUICHE_DIR/quiche" ]; then
            echo "‚ùå QUICHE directory not found at $QUICHE_DIR/quiche"
            exit 1
          fi
          
          cd "$QUICHE_DIR"
          
          # Checkout specific version if provided
          QUICHE_VERSION="${{ inputs.quiche_version || 'latest' }}"
          if [ "$QUICHE_VERSION" != "latest" ]; then
            echo "üìå Checking out QUICHE version: $QUICHE_VERSION"
            git fetch --tags || true
            git checkout "$QUICHE_VERSION" 2>/dev/null || echo "‚ö†Ô∏è  Version not found, using latest"
          fi
          
          echo "QUICHE commit: $(git rev-parse HEAD)"
          echo "Building for ${{ matrix.rust_target }} (${{ matrix.abi }})..."
          
          # Set optimization flags (LTO removed - incompatible with embed-bitcode=no in cross-compilation)
          export RUSTFLAGS="
            -C opt-level=3
            -C codegen-units=1
            -C panic=abort
            -C overflow-checks=off
            -C debug-assertions=off
          "
          
          # Build with cargo-ndk
          echo "üî® Building QUICHE..."
          cargo ndk \
            --target ${{ matrix.rust_target }} \
            --platform 29 \
            build \
            --release \
            --manifest-path quiche/Cargo.toml \
            --features ffi,qlog \
            --verbose
          
          # Verify build output
          LIB_PATH="target/${{ matrix.rust_target }}/release/libquiche.a"
          if [ ! -f "$LIB_PATH" ]; then
            echo "‚ùå Build failed - library not found at $LIB_PATH"
            echo "üìÅ Contents of target/${{ matrix.rust_target }}/release/:"
            ls -la "target/${{ matrix.rust_target }}/release/" || echo "Directory does not exist"
            exit 1
          fi
          
          echo "‚úÖ QUICHE built successfully"
          ls -lh "$LIB_PATH"

      - name: Copy Libraries to Output Directory
        run: |
          QUICHE_DIR="app/src/main/jni/quiche-client/third_party/quiche"
          OUTPUT_DIR="app/src/main/jni/quiche-client/libs"
          
          mkdir -p "$OUTPUT_DIR/${{ matrix.abi }}"
          
          # Copy static library
          if [ -f "$QUICHE_DIR/target/${{ matrix.rust_target }}/release/libquiche.a" ]; then
            cp "$QUICHE_DIR/target/${{ matrix.rust_target }}/release/libquiche.a" "$OUTPUT_DIR/${{ matrix.abi }}/"
            echo "‚úÖ Copied libquiche.a to $OUTPUT_DIR/${{ matrix.abi }}/"
          else
            echo "‚ùå libquiche.a not found"
            exit 1
          fi
          
          # Copy shared library if it exists
          if [ -f "$QUICHE_DIR/target/${{ matrix.rust_target }}/release/libquiche.so" ]; then
            cp "$QUICHE_DIR/target/${{ matrix.rust_target }}/release/libquiche.so" "$OUTPUT_DIR/${{ matrix.abi }}/"
            echo "‚úÖ Copied libquiche.so to $OUTPUT_DIR/${{ matrix.abi }}/"
          else
            echo "‚ö†Ô∏è  libquiche.so not found (static library only)"
          fi
          
          # Verify output
          echo "üì¶ Built libraries:"
          ls -lh "$OUTPUT_DIR/${{ matrix.abi }}/"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: quiche-${{ matrix.abi }}
          path: app/src/main/jni/quiche-client/libs/${{ matrix.abi }}/*
          retention-days: 7
          if-no-files-found: error

  verify:
    name: Verify QUICHE Binaries
    runs-on: ubuntu-22.04
    needs: build
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Verify Binaries
        run: |
          echo "üìã Verifying QUICHE libraries..."
          
          for abi in arm64-v8a x86_64; do
            if [ -f "artifacts/quiche-$abi/libquiche.a" ]; then
              SIZE=$(stat -c%s "artifacts/quiche-$abi/libquiche.a")
              SIZE_MB=$((SIZE / 1024 / 1024))
              echo "‚úÖ $abi (static): ${SIZE_MB}MB"
              
              # Check if it's an archive file
              file "artifacts/quiche-$abi/libquiche.a" || echo "‚ö†Ô∏è  $abi: Not a valid archive"
            else
              echo "‚ùå $abi: Static library not found"
            fi
            
            if [ -f "artifacts/quiche-$abi/libquiche.so" ]; then
              SIZE=$(stat -c%s "artifacts/quiche-$abi/libquiche.so")
              SIZE_MB=$((SIZE / 1024 / 1024))
              echo "‚úÖ $abi (shared): ${SIZE_MB}MB"
              
              # Check if binary is ELF
              file "artifacts/quiche-$abi/libquiche.so" || echo "‚ö†Ô∏è  $abi: Not a valid ELF file"
            else
              echo "‚ÑπÔ∏è  $abi: Shared library not found (static only)"
            fi
          done
          
          echo ""
          echo "üì¶ Library locations:"
          find artifacts -name "libquiche.*" -exec ls -lh {} \;


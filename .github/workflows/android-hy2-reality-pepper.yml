name: Chain Feature CI/CD

on:
  push:
    branches:
      - main
      - feature/reality-hysteria2-pepper-boringssl
    paths:
      - 'app/src/main/kotlin/com/simplexray/an/chain/**'
      - 'app/src/main/jni/pepper-shaper/**'
      - 'app/src/test/kotlin/com/simplexray/an/chain/**'
      - 'app/src/androidTest/kotlin/com/simplexray/an/chain/**'
      - '.github/workflows/android-hy2-reality-pepper.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'app/src/main/kotlin/com/simplexray/an/chain/**'
      - 'app/src/main/jni/pepper-shaper/**'
      - 'app/src/test/kotlin/com/simplexray/an/chain/**'
      - 'app/src/androidTest/kotlin/com/simplexray/an/chain/**'
  workflow_dispatch:
    inputs:
      skip_tests:
        description: "Skip tests"
        required: false
        default: false
        type: boolean
      build_abis:
        description: "ABIs to build (comma-separated)"
        required: false
        default: "arm64-v8a,armeabi-v7a,x86_64"
        type: string

env:
  GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx4g -Dorg.gradle.parallel=true -Dorg.gradle.caching=true"

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.skip_tests != 'true'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: false
      
      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"
          cache: "gradle"
      
      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
      
      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      
      - name: Run unit tests
        run: ./gradlew test --tests "com.simplexray.an.chain.*" --no-daemon
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: app/build/test-results/test/
          retention-days: 7

  build:
    name: Build APK (${{ matrix.abi }})
    runs-on: ubuntu-latest
    needs: [unit-tests]
    if: always() && (needs.unit-tests.result == 'success' || needs.unit-tests.result == 'skipped')
    
    strategy:
      fail-fast: false
      matrix:
        abi: ${{ github.event.inputs.build_abis && fromJSON(format('["{0}"]', join(split(github.event.inputs.build_abis, ','), '","'))) || ['arm64-v8a', 'armeabi-v7a', 'x86_64'] }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: true
      
      - name: Explicit Submodule Update
        run: |
          git submodule sync --recursive
          git submodule update --init --recursive
      
      - name: Read Versions
        run: |
          echo "XRAY_VERSION=$(grep 'XRAY_CORE_VERSION' version.properties | cut -d '=' -f 2)" >> $GITHUB_ENV
          echo "GO_VERSION=$(grep 'GO_VERSION' version.properties | cut -d '=' -f 2)" >> $GITHUB_ENV
      
      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"
          cache: "gradle"
      
      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false
      
      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      
      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
      
      - name: Setup Keystore (Debug)
        run: |
          # Use debug keystore for CI builds
          if [ ! -f debug.keystore ]; then
            keytool -genkey -v -keystore debug.keystore -storepass android -alias androiddebugkey -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Android Debug,O=Android,C=US"
          fi
      
      - name: Download Rules Files
        run: |
          GEOIP_VERSION=$(grep 'GEOIP_VERSION' version.properties | cut -d '=' -f 2)
          GEOSITE_VERSION=$(grep 'GEOSITE_VERSION' version.properties | cut -d '=' -f 2)
          mkdir -p ./app/src/main/assets
          wget -q https://github.com/lhear/v2ray-rules-dat/releases/download/$GEOIP_VERSION/geoip.dat -O ./app/src/main/assets/geoip.dat || true
          wget -q https://github.com/lhear/v2ray-rules-dat/releases/download/$GEOSITE_VERSION/geosite.dat -O ./app/src/main/assets/geosite.dat || true
      
      - name: Build Xray-core
        run: |
          # Setup NDK
          wget -qO android-ndk.zip https://dl.google.com/android/repository/android-ndk-r28c-linux.zip
          unzip -q android-ndk.zip
          rm android-ndk.zip
          NDK_HOME=$(realpath android-ndk-*)
          
          # Map ABI to Go arch
          case "${{ matrix.abi }}" in
            arm64-v8a)
              GOARCH="arm64"
              TOOLCHAIN="aarch64-linux-android24"
              ;;
            armeabi-v7a)
              GOARCH="arm"
              TOOLCHAIN="armv7a-linux-androideabi24"
              ;;
            x86_64)
              GOARCH="amd64"
              TOOLCHAIN="x86_64-linux-android24"
              ;;
          esac
          
          # Clone and build Xray-core
          git clone --depth=1 https://github.com/XTLS/Xray-core.git
          cd Xray-core
          git checkout ${{ env.XRAY_VERSION }} || true
          
          export GOOS=android
          export CGO_ENABLED=1
          export GOARCH=$GOARCH
          export CC=$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/$TOOLCHAIN-clang
          
          go build -o xray -trimpath -buildvcs=false -ldflags="-s -w" -v ./main
          
          mkdir -p ../app/src/main/jniLibs/${{ matrix.abi }}
          mv xray ../app/src/main/jniLibs/${{ matrix.abi }}/libxray.so
          cd ..
      
      - name: Build APK
        run: |
          ./gradlew assembleDebug -PABI_FILTER=${{ matrix.abi }} --no-daemon
      
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-${{ matrix.abi }}-debug
          path: app/build/outputs/apk/debug/*.apk
          retention-days: 7
          if-no-files-found: error

  instrumented-tests:
    name: Instrumented Tests
    runs-on: ubuntu-latest
    needs: [unit-tests]
    if: github.event.inputs.skip_tests != 'true'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: false
      
      - name: Set up Java 21
        uses: actions/setup-go@v5
        with:
          distribution: "temurin"
          java-version: "21"
          cache: "gradle"
      
      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
      
      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      
      - name: Run instrumented tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 29
          script: ./gradlew connectedAndroidTest --tests "com.simplexray.an.chain.*" --no-daemon
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: instrumented-test-results
          path: app/build/outputs/androidTest-results/
          retention-days: 7

  auto-fix:
    name: Auto-Fix on Failure
    runs-on: ubuntu-latest
    needs: [build, instrumented-tests]
    if: failure() && github.event_name == 'push'
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Setup GitHub CLI
        run: |
          type -p curl >/dev/null || (apt update && apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          apt update && apt install gh -y
      
      - name: Authenticate GitHub CLI
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
      
      - name: Download build logs
        uses: actions/download-artifact@v4
        with:
          pattern: '*-test-results'
          merge-multiple: true
      
      - name: Analyze failures and create fix PR
        run: |
          BRANCH_NAME="ci/autofix/chain-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH_NAME"
          
          # Create summary of failures
          cat > fix-summary.md << EOF
          # Auto-Fix Summary
          
          ## Build Failures Detected
          
          This PR was automatically created to address build failures in the chain feature.
          
          ### Failed Jobs:
          - Build jobs: Check logs for compilation errors
          - Test jobs: Check test results for failures
          
          ### Suggested Fixes:
          1. Review compilation errors in build logs
          2. Fix failing unit tests
          3. Update dependencies if needed
          4. Verify native library builds
          
          ### Logs:
          See attached artifacts for detailed logs.
          EOF
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add fix-summary.md
          git commit -m "ci: Add auto-fix summary for chain build failures"
          git push origin "$BRANCH_NAME"
          
          # Create PR
          gh pr create \
            --title "ðŸ”§ Auto-fix: Chain feature build failures" \
            --body-file fix-summary.md \
            --base main \
            --head "$BRANCH_NAME" \
            --label "ci,auto-fix" || echo "PR creation failed or already exists"

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build]
    if: startsWith(github.ref, 'refs/tags/') && needs.build.result == 'success'
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Download all APKs
        uses: actions/download-artifact@v4
        with:
          pattern: 'app-*-debug'
          merge-multiple: true
          path: artifacts
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ## Chain Feature Release
            
            This release includes the full tunneling stack:
            - Reality SOCKS (TLS mimic)
            - Hysteria2 QUIC accelerator
            - PepperShaper traffic shaping
            - BoringSSL mode support
            
            ### APKs
            - arm64-v8a
            - armeabi-v7a
            - x86_64
          files: artifacts/**/*.apk
          draft: false
          prerelease: false

